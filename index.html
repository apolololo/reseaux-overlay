<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width-width, initial-scale=1.0" />
  <title>APO Overlays</title>
  <link rel="stylesheet" href="./src/styles/main.css" />
  <link rel="stylesheet" href="./src/styles/app.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    #app { display: none; }
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-dark);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-left-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .studio-button {
      display: flex;
      align-items: center;
      gap: 8px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-right: 10px;
    }
    .studio-button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }
    .studio-button svg {
      fill: white;
    }
  </style>
</head>
<body>
  <div class="loading-screen">
    <div class="loading-spinner"></div>
  </div>

  <div id="app">
    <div class="overlay-list">
      <div class="header-container">
        <h2>Overlays</h2>
        <div class="user-info-container">
          <div id="twitch-info" class="twitch-info">
            <!-- Les informations utilisateur seront insérées ici -->
          </div>
          <button id="studio-button" class="studio-button">
            <svg viewBox="0 0 24 24" width="18" height="18">
              <path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 15.5h-1.5V14h-1v3H8v-3H7v4.5H5.5v-5c0-.55.45-1 1-1H11c.55 0 1 .45 1 1v5zm3.5 0H14v-6h3.5c.55 0 1 .45 1 1V16c0 .55-.45 1-1 1h-2v1.5zm-1-4.5H17v1h-2.5v-1zm0-3h2v1h-2v-1z"/>
            </svg>
            <span>Studio</span>
          </button>
          <button id="logout-button" class="logout-button">
            <svg viewBox="0 0 24 24" width="18" height="18">
              <path fill="currentColor" d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
            </svg>
            <span>Déconnexion</span>
          </button>
        </div>
      </div>
      <ul>
        <li class="overlay-item active" data-url="src/overlays/apo/overlay.html" data-size="800x200">
          Réseaux & Code
        </li>
        <li class="overlay-item" data-url="src/overlays/starting/overlay.html" data-size="1920x1080">
          Starting Soon
        </li>
        <li class="folder-item">
          <div class="folder-header">
            <span>Pause</span>
            <svg class="folder-icon" viewBox="0 0 24 24" width="24" height="24">
              <path fill="currentColor" d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
            </svg>
          </div>
          <ul class="folder-content">
            <li class="overlay-item" data-url="src/overlays/brb/overlay.html" data-size="1920x1080">
              Pause Standard
            </li>
            <li class="overlay-item" data-url="src/overlays/brb/overlay-video.html" data-size="1920x1080">
              Pause avec Zone Vidéo
            </li>
          </ul>
        </li>
        <li class="overlay-item" data-url="src/overlays/end/overlay.html" data-size="1920x1080">
          Fin du Stream
        </li>
        <li class="overlay-item" data-url="src/overlays/game-status/overlay.html" data-size="1920x1080">
          Status de Jeu
        </li>
        <li class="folder-item">
          <div class="folder-header">
            <span>Maps</span>
            <svg class="folder-icon" viewBox="0 0 24 24" width="24" height="24">
              <path fill="currentColor" d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
            </svg>
          </div>
          <ul class="folder-content">
            <li class="overlay-item" data-url="src/overlays/maps/overlay.html" data-size="1920x1080">
              Box Fights & Zone Wars
            </li>
          </ul>
        </li>
      </ul>
    </div>
    
    <div class="preview-section">
      <div class="preview-options">
        <div class="background-options">
          <label>Fond de preview :</label>
          <div class="background-controls">
            <input type="color" id="bg-color" value="#000000" title="Couleur de fond">
            <button id="bg-transparent" title="Fond transparent">
              <svg viewBox="0 0 24 24" width="24" height="24">
                <path fill="currentColor" d="M12 2L2 12l10 10 10-10L12 2zM4.83 12L12 19.17 19.17 12 12 4.83 4.83 12z"/>
              </svg>
            </button>
            <input type="file" id="bg-image" accept="image/*" hidden>
            <button id="bg-image-btn" title="Image de fond">
              <svg viewBox="0 0 24 24" width="24" height="24">
                <path fill="currentColor" d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div class="preview-container">
        <div class="preview-background">
          <iframe id="overlay-preview" src="/src/overlays/apo/overlay.html"></iframe>
        </div>
      </div>

      <div class="copy-info">
        <button id="copy-url">
          <svg viewBox="0 0 24 24" width="18" height="18">
            <path fill="currentColor" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
          </svg>
          Copier l'URL pour OBS
        </button>
        <span class="size-info">Taille recommandée : 800x200</span>
      </div>
    </div>
  </div>

  <script type="module" src="./src/js/main.js"></script>
  <script type="module">
    document.addEventListener('DOMContentLoaded', () => {
      const app = document.getElementById('app');
      const loadingScreen = document.querySelector('.loading-screen');

      const checkAuth = () => {
        const token = localStorage.getItem('twitch_token');
        const expiresAt = localStorage.getItem('twitch_expires_at');
        const userData = localStorage.getItem('twitch_user');
        
        if (!token || !expiresAt || new Date().getTime() > parseInt(expiresAt)) {
          window.location.href = './src/auth.html';
          return false;
        }
        
        // Afficher l'interface une fois l'authentification vérifiée
        loadingScreen.style.display = 'none';
        app.style.display = 'flex';
        
        // Afficher les informations utilisateur
        if (userData) {
          try {
            const user = JSON.parse(userData);
            const twitchInfo = document.getElementById('twitch-info');
            if (twitchInfo && user) {
              twitchInfo.innerHTML = `
                <div class="user-profile">
                  ${user.profile_image_url ? `<img src="${user.profile_image_url}" alt="${user.display_name}">` : ''}
                  <span class="username">${user.display_name || 'Utilisateur Twitch'}</span>
                </div>
              `;
            }
          } catch (e) {
            console.error("Erreur lors de l'affichage des infos utilisateur", e);
          }
        }
        
        return true;
      };
      
      // Vérifier l'authentification au chargement
      checkAuth();
      
      // Gérer le bouton Studio
      const studioButton = document.getElementById('studio-button');
      if (studioButton) {
        studioButton.addEventListener('click', () => {
          window.location.href = './src/studio.html';
        });
      }
      
      // Gérer la déconnexion
      const logoutButton = document.getElementById('logout-button');
      if (logoutButton) {
        logoutButton.addEventListener('click', () => {
          localStorage.removeItem('twitch_token');
          localStorage.removeItem('twitch_expires_at');
          localStorage.removeItem('twitch_user');
          localStorage.removeItem('twitch_subscriber_count');
          localStorage.removeItem('twitch_subscriber_points');
          window.location.href = './src/auth.html';
        });
      }
    });
  </script>
</body>
</html>
