
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âditeur d'Overlay - R√©seaux Overlay</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 2rem;
            font-weight: 700;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .overlay-name {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .overlay-name:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .editor-container {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            min-height: 0;
        }

        .editor-panel, .preview-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            background: #f7fafc;
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            color: #4a5568;
        }

        .file-tabs {
            display: flex;
            background: #edf2f7;
            border-bottom: 1px solid #e2e8f0;
        }

        .file-tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #718096;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .file-tab:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #4a5568;
        }

        .file-tab.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .editor-content {
            flex: 1;
            position: relative;
        }

        .CodeMirror {
            height: 100% !important;
            font-size: 14px;
            line-height: 1.5;
        }

        .preview-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: #000;
            /* Aspect ratio 16:9 pour 1920x1080 */
            aspect-ratio: 16/9;
        }

        .preview-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            /* Forcer la taille 1920x1080 avec scaling */
        }

        .preview-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            padding: 10px;
        }

        .preview-wrapper {
            width: 100%;
            max-width: 1920px;
            aspect-ratio: 16/9;
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #48bb78;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(0);
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #718096;
            font-size: 18px;
        }

        @media (max-width: 768px) {
            .editor-container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 1fr;
            }
            
            .header-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .overlay-name {
                min-width: auto;
            }
        }

        .file-list {
            background: #f7fafc;
            border-bottom: 1px solid #e2e8f0;
            padding: 10px;
        }

        .file-item {
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #4a5568;
            font-size: 14px;
        }

        .file-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .file-item.active {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <nav id="main-navigation"></nav>
    <div class="container">
        <div class="header">
            <h1>üé® √âditeur d'Overlay</h1>
            <div class="header-controls">
                <input type="text" id="overlayName" class="overlay-name" placeholder="Nom de votre overlay..." value="Mon Overlay">
                <button id="saveBtn" class="btn btn-primary">üíæ Sauvegarder</button>
                <button id="copyUrlBtn" class="btn btn-secondary">üîó Copier l'URL</button>
                <button id="openOverlayBtn" class="btn btn-secondary">üöÄ Ouvrir l'Overlay</button>
                <a href="index.html" class="btn btn-secondary">üè† Accueil</a>
            </div>
        </div>

        <div class="editor-container">
            <div class="editor-panel">
                <div class="panel-header">√âditeur de Code</div>
                <div class="file-tabs">
                    <button class="file-tab active" data-file="html">üìÑ index.html</button>
                    <button class="file-tab" data-file="css">üé® style.css</button>
                    <button class="file-tab" data-file="js">‚ö° script.js</button>
                </div>
                <div class="editor-content">
                    <div id="editor"></div>
                </div>
            </div>

            <div class="preview-panel">
                <div class="panel-header">Aper√ßu en Temps R√©el (1920x1080)</div>
                <div class="preview-container">
                    <div class="preview-wrapper">
                        <iframe id="preview" class="preview-iframe"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <!-- Scripts CodeMirror -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closetag.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/xml-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/brace-fold.min.js"></script>

    <script type="module">
      // V√©rification de l'authentification avant d'initialiser l'√©diteur
      document.addEventListener('DOMContentLoaded', function() {
        const isLoggedIn = localStorage.getItem('user_logged_in');
        const userToken = localStorage.getItem('user_token');
        const twitchUser = localStorage.getItem('twitch_user');
        
        console.log('V√©rification de l\'authentification sur l\'√©diteur:', {
          isLoggedIn: isLoggedIn,
          hasToken: !!userToken,
          hasTwitchUser: !!twitchUser
        });
        
        // Si l'utilisateur n'est pas connect√©, rediriger vers la page de connexion
        if (!isLoggedIn && !userToken) {
          console.log('Utilisateur non connect√©, redirection vers auth/auth.html');
          window.location.href = '/auth/auth.html';
          return;
        }
        
        // Charger le composant de navigation
        const script = document.createElement('script');
        script.src = '/src/components/navigation.js';
        script.type = 'text/javascript';
        document.head.appendChild(script);
        
        // Initialiser l'√©diteur seulement si l'utilisateur est connect√©
        new OverlayEditor();
      });

      class OverlayEditor {
        constructor() {
          this.currentTab = 'html';
          this.editor = null;
          this.overlayName = 'Mon Overlay';
          this.overlayId = this.generateId();
          this.files = {
            html: '',
            css: '',
            js: ''
          };
          
          // V√©rifier si un ID d'overlay est sp√©cifi√© dans l'URL
          const params = new URLSearchParams(window.location.search);
          const editId = params.get('id');
          
          if (editId) {
            this.overlayId = editId;
            console.log('√âdition de l\'overlay existant:', editId);
          }
          
          this.init();
        }
        
        generateId() {
          return 'overlay_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
        }

        getDefaultFiles() {
          return {
            html: `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Overlay</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            background: transparent;
            width: 1920px;
            height: 1080px;
        }

        #overlay-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .overlay-element {
            position: absolute;
            top: 50px;
            left: 50px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            pointer-events: auto;
        }

        .overlay-element h1 {
            font-size: 48px;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div id="overlay-container">
        <div class="overlay-element">
            <h1>Mon Overlay</h1>
            <p>Bienvenue dans votre overlay personnalis√© !</p>
        </div>
    </div>
</body>
</html>`,
            css: `/* Styles de base pour l'overlay */
body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    font-family: 'Arial', sans-serif;
    background: transparent;
    width: 1920px;
    height: 1080px;
}

#overlay-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
}

.overlay-element {
    position: absolute;
    top: 50px;
    left: 50px;
    color: white;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    pointer-events: auto;
}

.overlay-element h1 {
    font-size: 48px;
    margin: 0;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    animation: fadeIn 1s ease-in;
}

.overlay-element p {
    font-size: 24px;
    margin: 10px 0;
    padding: 10px 20px;
    background: rgba(0, 0, 0, 0.7);
    border-radius: 5px;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}`,
            js: `// Configuration de base pour l'overlay
const config = {
    title: "Mon Overlay",
    position: { x: 50, y: 50 },
    colors: {
        primary: "#667eea",
        secondary: "#764ba2",
        text: "#ffffff"
    }
};

// Fonction d'initialisation
function initOverlay() {
    console.log("Overlay initialis√© avec succ√®s");
    
    // Ajouter une animation d'entr√©e
    const overlayElement = document.querySelector('.overlay-element');
    if (overlayElement) {
        overlayElement.style.animation = 'fadeIn 1s ease-in';
    }
}

// Initialisation au chargement
document.addEventListener('DOMContentLoaded', initOverlay);`
          };
        }

        init() {
          console.log("Initialisation de l'√©diteur d'overlay");
          
          // Charger les fichiers par d√©faut
          this.files = this.getDefaultFiles();
          
          setTimeout(() => {
            this.setupEditor();
            this.setupEventListeners();
            this.loadOverlayData();
          }, 100);
        }

        setupEditor() {
          const editorElement = document.getElementById('editor');
          if (!editorElement) {
            console.error("√âl√©ment editor non trouv√©");
            return;
          }

          // V√©rifier que CodeMirror est disponible
          if (typeof CodeMirror === 'undefined') {
            console.error("CodeMirror n'est pas charg√©");
            return;
          }

          try {
            this.editor = CodeMirror(editorElement, {
              value: this.files[this.currentTab],
              mode: this.getEditorMode(this.currentTab),
              theme: 'monokai',
              lineNumbers: true,
              autoCloseTags: true,
              autoCloseBrackets: true,
              indentUnit: 2,
              tabSize: 2,
              lineWrapping: true,
              extraKeys: {
                "Ctrl-S": () => {
                  this.saveOverlay();
                  return false;
                },
                "Tab": function(cm) {
                  if (cm.somethingSelected()) {
                    cm.indentSelection("add");
                  } else {
                    cm.replaceSelection("  ");
                  }
                }
              },
              foldGutter: true,
              gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"]
            });

            console.log("CodeMirror initialis√© avec succ√®s");

            // √âv√©nement de changement
            this.editor.on('change', () => {
              this.updatePreview();
            });

            setTimeout(() => {
              this.editor.refresh();
              this.editor.focus();
              console.log("√âditeur rafra√Æchi et focalis√©");
            }, 100);

          } catch (error) {
            console.error("Erreur lors de l'initialisation de CodeMirror:", error);
          }
        }

        setupEventListeners() {
          // Gestionnaires pour les onglets de fichiers
          document.querySelectorAll('.file-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
              const fileType = e.target.dataset.file;
              if (fileType) {
                this.switchTab(fileType);
              }
            });
          });

          // Gestionnaires pour les actions principales
          const saveBtn = document.getElementById('saveBtn');
          if (saveBtn) {
            saveBtn.addEventListener('click', () => this.saveOverlay());
          }

          const copyUrlBtn = document.getElementById('copyUrlBtn');
          if (copyUrlBtn) {
            copyUrlBtn.addEventListener('click', () => this.copyOverlayUrl());
          }

          const openOverlayBtn = document.getElementById('openOverlayBtn');
          if (openOverlayBtn) {
            openOverlayBtn.addEventListener('click', () => this.openOverlayInNewTab());
          }

          const overlayName = document.getElementById('overlayName');
          if (overlayName) {
            overlayName.addEventListener('input', (e) => {
              this.overlayName = e.target.value;
            });
          }
        }

        loadOverlayData() {
          // V√©rifier s'il y a un overlay √† charger depuis l'URL
          if (!this.loadExistingOverlay()) {
            this.createNewOverlay();
          }
          
          // S'assurer que l'√©diteur est correctement initialis√©
          setTimeout(() => {
            if (this.editor) {
              this.editor.setValue(this.files[this.currentTab] || '');
              this.updatePreview();
            }
          }, 300);
        }

        loadExistingOverlay() {
          const params = new URLSearchParams(window.location.search);
          const overlayId = params.get('id');
          
          if (overlayId) {
            const savedOverlay = localStorage.getItem(`overlay_${overlayId}`);
            if (savedOverlay) {
              try {
                const overlay = JSON.parse(savedOverlay);
                this.overlayId = overlayId;
                this.overlayName = overlay.name || 'Mon Overlay';
                this.files = overlay.files || this.files;
                
                document.getElementById('overlayName').value = this.overlayName;
                
                if (this.editor) {
                  this.editor.setValue(this.files[this.currentTab]);
                }
                this.updatePreview();
                return true;
              } catch (error) {
                console.error('Erreur lors du chargement de l\'overlay:', error);
              }
            }
          }
          return false;
        }

        createNewOverlay() {
          this.overlayId = this.generateOverlayId();
          
          if (this.editor) {
            this.editor.setValue(this.files[this.currentTab]);
          }
          
          this.updatePreview();
        }

        generateOverlayId() {
          // G√©n√©rer un ID unique bas√© sur timestamp + random
          const timestamp = Date.now().toString(36);
          const random = Math.random().toString(36).substr(2, 9);
          return `overlay_${timestamp}_${random}`;
        }

        switchTab(tab) {
          console.log("Changement d'onglet vers:", tab);
          
          if (!this.editor) {
            console.error("√âditeur non initialis√©");
            return;
          }
          
          // Sauvegarder le contenu de l'onglet actuel avant de changer
          if (this.editor) {
            this.files[this.currentTab] = this.editor.getValue();
          }
          
          this.currentTab = tab;
          
          // Mettre √† jour l'interface
          document.querySelectorAll('.editor-tab.active, .file-item.active').forEach(el => {
            el.classList.remove('active');
          });
          
          // Activer les nouveaux onglets
          document.querySelectorAll(`[data-file="${tab}"]`).forEach(el => {
            el.classList.add('active');
          });
          
          // Changer le mode et le contenu de l'√©diteur
          this.editor.setOption('mode', this.getEditorMode(tab));
          this.editor.setValue(this.files[tab] || '');
          
          // Rafra√Æchir l'√©diteur
          setTimeout(() => {
            this.editor.refresh();
            this.editor.setCursor(0, 0);
            this.editor.focus();
          }, 10);
        }

        getEditorMode(fileType) {
          const modes = {
            'html': 'htmlmixed',
            'css': 'css',
            'js': 'javascript'
          };
          return modes[fileType] || 'text/plain';
        }

        generateOverlayUrl() {
          // Sauvegarder le contenu actuel
          if (this.editor) {
            this.files[this.currentTab] = this.editor.getValue();
          }
          
          // Construire l'URL absolue
          const baseUrl = window.location.origin + window.location.pathname.replace('editor.html', '');
          const overlayUrl = `${baseUrl}overlay.html?id=${this.overlayId}`;
          
          // Mettre √† jour l'URL de la page actuelle
          const newUrl = `${window.location.pathname}?id=${this.overlayId}`;
          window.history.replaceState({}, '', newUrl);
          
          return overlayUrl;
        }

        copyOverlayUrl() {
          const url = this.generateOverlayUrl();
          navigator.clipboard.writeText(url).then(() => {
            this.showToast('URL copi√©e dans le presse-papier !');
            console.log('URL copi√©e:', url);
          }).catch(() => {
            this.showToast('Erreur lors de la copie de l\'URL');
          });
        }

        openOverlayInNewTab() {
          // Sauvegarder le contenu actuel
          if (this.editor) {
            this.files[this.currentTab] = this.editor.getValue();
          }
          
          // Construire l'URL avec les param√®tres d'overlay encod√©s
          const baseUrl = window.location.origin + window.location.pathname.replace('editor.html', '');
          const htmlContent = encodeURIComponent(this.files.html || '');
          const cssContent = encodeURIComponent(this.files.css || '');
          const jsContent = encodeURIComponent(this.files.js || '');
          const overlayName = encodeURIComponent(this.overlayName || 'Mon Overlay');
          
          const overlayUrl = `${baseUrl}overlay.html?id=${this.overlayId}&html=${htmlContent}&css=${cssContent}&js=${jsContent}&name=${overlayName}`;
          
          // Ouvrir dans un nouvel onglet
          window.open(overlayUrl, '_blank');
          this.showToast('Overlay ouvert dans un nouvel onglet !');
        }

        updatePreview() {
          console.log("Mise √† jour de l'aper√ßu");
          
          // Sauvegarder le contenu actuel
          if (this.editor) {
            this.files[this.currentTab] = this.editor.getValue();
          }
          
          // R√©cup√©rer l'iframe
          const iframe = document.getElementById('preview');
          if (!iframe) return;
          
          // Cr√©er le contenu HTML complet avec r√©solution 1920x1080
          const fullHtml = `
            <!DOCTYPE html>
            <html>
            <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=1920, height=1080, initial-scale=1.0">
              <style>
                html, body {
                  margin: 0;
                  padding: 0;
                  width: 1920px;
                  height: 1080px;
                  background: transparent;
                  overflow: hidden;
                  transform-origin: top left;
                }
                ${this.files.css || ''}
              </style>
            </head>
            <body>
              ${this.files.html || ''}
              <script>
                try {
                  ${this.files.js || ''}
                } catch(e) {
                  console.error('Erreur dans le script:', e);
                }
              <\/script>
            </body>
            </html>
          `;
          
          // Mettre √† jour l'iframe
          iframe.srcdoc = fullHtml;
        }

        async saveOverlay() {
          try {
            // V√©rifier que nous avons un ID d'overlay valide
            if (!this.overlayId) {
              console.error('Aucun ID d\'overlay d√©fini');
              this.showToast('Erreur: Aucun ID d\'overlay d√©fini');
              return;
            }

            // Sauvegarder le contenu actuel de tous les onglets
            if (this.editor) {
              this.files[this.currentTab] = this.editor.getValue();
            }
            
            // S'assurer que tous les fichiers sont sauvegard√©s
            const allFiles = {
              html: this.files.html || '',
              css: this.files.css || '',
              js: this.files.js || ''
            };
            
            // Cr√©er l'objet overlay avec toutes les donn√©es
            const overlay = {
              id: this.overlayId,
              name: this.overlayName || 'Mon Overlay',
              files: allFiles,
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString()
            };

            console.log('Sauvegarde de l\'overlay:', overlay);

            // Sauvegarder dans localStorage pour l'√©diteur
            const saveKey = `overlay_${this.overlayId}`;
            localStorage.setItem(saveKey, JSON.stringify(overlay));
            console.log('Donn√©es sauvegard√©es avec la cl√©:', saveKey);
            
            // Sauvegarder dans la liste des overlays
            let myOverlays = JSON.parse(localStorage.getItem('my_overlays') || '[]');
            const existingIndex = myOverlays.findIndex(o => o.id === this.overlayId);
            
            const overlayListItem = {
              id: this.overlayId,
              name: this.overlayName || 'Mon Overlay',
              createdAt: overlay.createdAt,
              updatedAt: overlay.updatedAt
            };
            
            if (existingIndex !== -1) {
              // Mettre √† jour l'overlay existant
              myOverlays[existingIndex] = overlayListItem;
              console.log('Overlay existant mis √† jour dans la liste');
            } else {
              // Ajouter un nouvel overlay
              myOverlays.push(overlayListItem);
              console.log('Nouvel overlay ajout√© √† la liste');
            }
            
            // Sauvegarder la liste mise √† jour
            localStorage.setItem('my_overlays', JSON.stringify(myOverlays));
            console.log('Liste des overlays mise √† jour:', myOverlays);
            
            // Mettre √† jour l'URL pour refl√©ter l'ID actuel
            const newUrl = `${window.location.pathname}?id=${this.overlayId}`;
            window.history.replaceState({}, '', newUrl);
            
            // Mettre √† jour le titre de la page
            document.title = `√âditeur d'Overlay - ${this.overlayName}`;
            
            this.showToast('Overlay sauvegard√© avec succ√®s !');
            console.log('Overlay sauvegard√©:', overlay);
            
            // Forcer la mise √† jour de la pr√©visualisation
            this.updatePreview();
            
          } catch (error) {
            console.error('Erreur lors de la sauvegarde:', error);
            this.showToast('Erreur lors de la sauvegarde de l\'overlay: ' + error.message);
          }
        }

        showToast(message) {
          const toast = document.getElementById('toast');
          toast.textContent = message;
          toast.classList.add('show');
          setTimeout(() => toast.classList.remove('show'), 3000);
        }
      }

      // Initialiser l'√©diteur
      document.addEventListener('DOMContentLoaded', () => {
        new OverlayEditor();
      });
    </script>
    <script src="src/components/navigation.js"></script>
</body>
</html>
