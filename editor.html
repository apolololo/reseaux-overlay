<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Éditeur d'Overlay - APO Overlays</title>
  
  <!-- Fonts et CSS externes -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.5.95/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css" rel="stylesheet">
  
  <style>
    :root {
      --primary: #9146FF;
      --secondary: #00ADB5;
      --background: #0e0e10;
      --surface: #18181b;
      --text: #efeff1;
      --text-secondary: #adadb8;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background: var(--background);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: var(--surface);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header h1 {
      font-size: 24px;
      font-weight: 600;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .button:hover {
      opacity: 0.9;
    }

    .button.secondary {
      background: rgba(255, 255, 255, 0.1);
    }

    .main-content {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      padding: 24px;
      height: calc(100vh - 73px);
    }

    .editor-section {
      display: flex;
      flex-direction: column;
      background: var(--surface);
      border-radius: 12px;
      overflow: hidden;
    }

    .editor-tabs {
      display: flex;
      background: rgba(255, 255, 255, 0.05);
      padding: 8px;
      gap: 8px;
    }

    .editor-tab {
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.2s;
    }

    .editor-tab.active {
      background: var(--primary);
      color: white;
    }

    .editor-tab:hover:not(.active) {
      background: rgba(255, 255, 255, 0.1);
    }

    .CodeMirror {
      flex: 1;
      height: 100% !important;
      font-family: 'Fira Code', monospace;
      font-size: 14px;
    }

    .preview-section {
      background: var(--surface);
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .preview-header {
      padding: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .preview-header h2 {
      font-size: 18px;
      font-weight: 600;
    }

    .preview-actions {
      display: flex;
      gap: 8px;
    }

    .preview-frame {
      flex: 1;
      border: none;
      background: white;
      width: 1920px;
      height: 1080px;
      transform: scale(0.5);
      transform-origin: top left;
    }

    .overlay-name {
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 24px;
      font-weight: 600;
      font-family: 'Montserrat', sans-serif;
      width: 300px;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .overlay-name:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.1);
    }

    .overlay-url {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-secondary);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .overlay-url:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .overlay-url i {
      color: var(--primary);
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--surface);
      color: var(--text);
      padding: 12px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 8px;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
  </style>
</head>
<body>
  <header class="header">
    <input type="text" class="overlay-name" placeholder="Nom de l'overlay" id="overlayName">
    <div class="header-actions">
      <div class="overlay-url" id="overlayUrl">
        <i class="mdi mdi-link"></i>
        <span>URL de l'overlay</span>
      </div>
      <button class="button" id="saveBtn">
        <i class="mdi mdi-content-save"></i>
        Enregistrer
      </button>
    </div>
  </header>

  <main class="main-content">
    <section class="editor-section">
      <div class="editor-tabs">
        <div class="editor-tab active" data-tab="html">HTML</div>
        <div class="editor-tab" data-tab="css">CSS</div>
        <div class="editor-tab" data-tab="js">JavaScript</div>
      </div>
      <div id="editor"></div>
    </section>

    <section class="preview-section">
      <div class="preview-header">
        <h2>Aperçu</h2>
      </div>
      <iframe class="preview-frame" id="previewFrame"></iframe>
    </section>
  </main>

  <div class="toast" id="toast">
    <i class="mdi mdi-check-circle"></i>
    <span>Overlay enregistré avec succès !</span>
  </div>

  <!-- Scripts CodeMirror -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>

  <script>
    class OverlayEditor {
      constructor() {
        this.editor = null;
        this.currentTab = 'html';
        this.overlayName = '';
        this.overlayId = '';
        this.files = {
          html: '',
          css: '',
          js: ''
        };
        this.init();
      }

      init() {
        this.setupEditor();
        this.setupEventListeners();
        this.loadOverlay();
      }

      setupEditor() {
        this.editor = CodeMirror(document.getElementById('editor'), {
          mode: 'htmlmixed',
          theme: 'monokai',
          lineNumbers: true,
          autoCloseTags: true,
          autoCloseBrackets: true,
          matchBrackets: true,
          indentUnit: 2,
          tabSize: 2,
          lineWrapping: true
        });
      }

      setupEventListeners() {
        // Gestion des onglets
        document.querySelectorAll('.editor-tab').forEach(tab => {
          tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
        });

        // Boutons d'action
        document.getElementById('saveBtn').addEventListener('click', () => this.saveOverlay());
        document.getElementById('overlayUrl').addEventListener('click', () => this.copyOverlayUrl());

        // Nom de l'overlay
        document.getElementById('overlayName').addEventListener('input', (e) => {
          this.overlayName = e.target.value;
        });

        // Auto-save
        this.editor.on('change', () => {
          this.files[this.currentTab] = this.editor.getValue();
          this.updatePreview();
        });
      }

      switchTab(tab) {
        this.currentTab = tab;
        document.querySelectorAll('.editor-tab').forEach(t => {
          t.classList.toggle('active', t.dataset.tab === tab);
        });

        this.editor.setOption('mode', {
          html: 'htmlmixed',
          css: 'css',
          js: 'javascript'
        }[tab]);

        this.editor.setValue(this.files[tab] || '');
      }

      loadOverlay() {
        const savedOverlay = localStorage.getItem('current_overlay');
        if (savedOverlay) {
          const overlay = JSON.parse(savedOverlay);
          this.overlayName = overlay.name;
          this.overlayId = overlay.id || this.generateOverlayId();
          this.files = overlay.files;
          document.getElementById('overlayName').value = overlay.name;
          this.updateOverlayUrl();
          this.editor.setValue(this.files.html);
        } else {
          this.overlayId = this.generateOverlayId();
          // Template par défaut
          this.files.html = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Mon Overlay</title>
</head>
<body>
    <div class="overlay">
        <h1>Bienvenue !</h1>
    </div>
</body>
</html>`;
          this.files.css = `body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
}

.overlay {
    width: 100vw;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
}

h1 {
    color: white;
    font-size: 48px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
}`;
          this.files.js = `// Votre code JavaScript ici
console.log('Overlay chargé !');`;
          this.editor.setValue(this.files.html);
          this.updateOverlayUrl();
        }
      }

      generateOverlayId() {
        return 'overlay_' + Math.random().toString(36).substr(2, 9);
      }

      updateOverlayUrl() {
        const url = `${window.location.origin}/overlay.html?id=${this.overlayId}`;
        document.getElementById('overlayUrl').querySelector('span').textContent = url;
      }

      copyOverlayUrl() {
        const url = document.getElementById('overlayUrl').querySelector('span').textContent;
        navigator.clipboard.writeText(url).then(() => {
          this.showToast('URL copiée dans le presse-papier !');
        });
      }

      updatePreview() {
        const frame = document.getElementById('previewFrame');
        const content = `
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <style>
                body {
                  margin: 0;
                  padding: 0;
                  width: 1920px;
                  height: 1080px;
                  overflow: hidden;
                }
                ${this.files.css}
              </style>
          </head>
          <body>
              ${this.files.html}
              <script>${this.files.js}<\/script>
          </body>
          </html>
        `;
        frame.srcdoc = content;
      }

      saveOverlay() {
        if (!this.overlayName) {
          this.showToast('Veuillez donner un nom à votre overlay');
          return;
        }

        const overlay = {
          id: this.overlayId,
          name: this.overlayName,
          files: this.files,
          createdAt: new Date().toISOString()
        };

        // Sauvegarder dans la liste des overlays
        const overlays = JSON.parse(localStorage.getItem('my_overlays') || '[]');
        const existingIndex = overlays.findIndex(o => o.id === this.overlayId);
        
        if (existingIndex >= 0) {
          overlays[existingIndex] = overlay;
        } else {
          overlays.push(overlay);
        }

        localStorage.setItem('my_overlays', JSON.stringify(overlays));
        localStorage.setItem('current_overlay', JSON.stringify(overlay));
        this.showToast('Overlay enregistré avec succès !');
      }

      showToast(message) {
        const toast = document.getElementById('toast');
        toast.querySelector('span').textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
      }
    }

    // Initialiser l'éditeur
    const editor = new OverlayEditor();
  </script>
</body>
</html>