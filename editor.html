<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Éditeur d'Overlay - APO Overlays</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.5.95/css/materialdesignicons.min.css" rel="stylesheet">
  
  <!-- CodeMirror Core CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
  
  <!-- Thèmes CodeMirror -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/vscode-dark.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css" rel="stylesheet">
  
  <!-- Addons CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.css" rel="stylesheet">

  <style>
    :root {
      --primary: #9146FF;
      --secondary: #00ADB5;
      --background: #0e0e10;
      --surface: #18181b;
      --text: #efeff1;
      --text-secondary: #adadb8;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background: var(--background);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: var(--surface);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header h1 {
      font-size: 24px;
      font-weight: 600;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .overlay-name {
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 24px;
      font-weight: 600;
      font-family: 'Montserrat', sans-serif;
      width: 300px;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .overlay-name:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.1);
    }

    .button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .button:hover {
      opacity: 0.9;
    }

    .button.secondary {
      background: rgba(255, 255, 255, 0.1);
    }

    .main-content {
      flex: 1;
      display: grid;
      grid-template-columns: 250px 1fr 1fr;
      gap: 24px;
      padding: 24px;
      height: calc(100vh - 73px);
    }

    .file-explorer {
      background: var(--surface);
      border-radius: 12px;
      padding: 20px;
    }

    .file-explorer-header {
      margin-bottom: 20px;
    }

    .file-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .file-item {
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .file-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .file-item.active {
      background: var(--primary);
      color: white;
    }

    .editor-section {
      display: flex;
      flex-direction: column;
      background: var(--surface);
      border-radius: 12px;
      overflow: hidden;
    }

    .editor-tabs {
      display: flex;
      background: rgba(255, 255, 255, 0.05);
      padding: 8px;
      gap: 8px;
    }

    .editor-tab {
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.2s;
    }

    .editor-tab.active {
      background: var(--primary);
      color: white;
    }

    .editor-tab:hover:not(.active) {
      background: rgba(255, 255, 255, 0.1);
    }

    #editor {
      flex: 1;
      height: 100%;
      min-height: 400px;
    }

    .CodeMirror {
      height: 100% !important;
      font-family: 'Fira Code', monospace;
      font-size: 14px;
      line-height: 1.5;
      background: #1e1e1e !important;
    }

    .CodeMirror-scroll {
      height: 100% !important;
    }

    .preview-section {
      background: var(--surface);
      border-radius: 12px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .preview-container {
      flex: 1;
      position: relative;
      overflow: hidden;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
    }

    .preview-frame {
      width: 1920px;
      height: 1080px;
      transform: scale(0.5);
      transform-origin: top left;
      border: none;
      background: transparent;
      position: relative;
      z-index: 1;
    }
    
    .preview-dimensions {
      position: absolute;
      top: 0;
      left: 0;
      width: 960px;
      height: 540px;
      border: 2px solid var(--primary);
      pointer-events: none;
      z-index: 2;
      box-sizing: border-box;
    }
    
    .preview-dimensions::after {
      content: "1920 x 1080";
      position: absolute;
      top: -25px;
      right: 0;
      background: var(--primary);
      color: white;
      padding: 2px 8px;
      font-size: 12px;
      border-radius: 4px;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--surface);
      color: var(--text);
      padding: 12px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 8px;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
  </style>
</head>
<body>
  <header class="header">
    <input type="text" class="overlay-name" placeholder="Nom de l'overlay" id="overlayName">
    <div class="header-actions">
        <button class="button secondary" id="copyUrlBtn">
          <i class="mdi mdi-link"></i>
          Copier URL
        </button>

        <button class="button" id="saveBtn">
          <i class="mdi mdi-content-save"></i>
          Enregistrer
        </button>
      </div>
  </header>

  <main class="main-content">
    <div class="file-explorer">
        <div class="file-explorer-header">
          <h2>Fichiers</h2>
        </div>
        <div class="file-list">
          <div class="file-item active" data-tab="html">
            <i class="mdi mdi-language-html5"></i>
            index.html
          </div>
          <div class="file-item" data-tab="css">
            <i class="mdi mdi-language-css3"></i>
            style.css
          </div>
          <div class="file-item" data-tab="js">
            <i class="mdi mdi-language-javascript"></i>
            script.js
          </div>
        </div>
      </div>

    <section class="editor-section">
      <div class="editor-tabs">
        <div class="editor-tab active" data-tab="html">HTML</div>
        <div class="editor-tab" data-tab="css">CSS</div>
        <div class="editor-tab" data-tab="js">JavaScript</div>
      </div>
      <div id="editor"></div>
      <textarea id="html-editor" style="display: none;"></textarea>
      <textarea id="css-editor" style="display: none;"></textarea>
      <textarea id="js-editor" style="display: none;"></textarea>
    </section>

    <section class="preview-section">
      <h2>Aperçu</h2>
      <div class="preview-container">
        <iframe id="preview-frame" class="preview-frame"></iframe>
        <div class="preview-dimensions"></div>
      </div>
    </section>
  </main>

  <div class="toast" id="toast">
    <i class="mdi mdi-check-circle"></i>
    <span>Overlay enregistré avec succès !</span>
  </div>

  <!-- CodeMirror Core -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  
  <!-- Modes pour les langages -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
  
  <!-- Addons pour l'autocomplétion -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/html-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/css-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/javascript-hint.min.js"></script>
  
  <!-- Addons pour les parenthèses et balises -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closetag.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchtags.min.js"></script>
  
  <!-- Addons pour la recherche -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/search.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/searchcursor.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/jump-to-line.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.js"></script>
  
  <!-- Addons pour le pliage de code -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/brace-fold.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/xml-fold.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/comment-fold.min.js"></script>

  <script>
    class OverlayEditor {
      constructor() {
        this.editors = {
          html: null,
          css: null,
          js: null
        };
        this.currentTab = 'html';
        this.overlayName = '';
        this.overlayId = '';
        this.files = {
          html: `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Overlay</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="overlay-container">
        <!-- Votre contenu d'overlay ici -->
        <div class="overlay-element">
            <h1>Mon Overlay</h1>
        </div>
    </div>
    <script src="script.js"></script>
</body>
</html>`,
          css: `/* Styles de base pour l'overlay */
body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    font-family: Arial, sans-serif;
}

#overlay-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
}

.overlay-element {
    position: absolute;
    color: white;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
}

/* Exemple de style pour le titre */
.overlay-element h1 {
    font-size: 24px;
    margin: 0;
    padding: 10px;
}`,
          js: `// Configuration de base pour l'overlay
const config = {
    // Ajoutez vos variables de configuration ici
    title: "Mon Overlay",
    position: { x: 20, y: 20 }
};

// Fonction d'initialisation
function initOverlay() {
    // Code d'initialisation ici
    console.log("Overlay initialisé");
}

// Fonction pour mettre à jour l'overlay
function updateOverlay() {
    // Code de mise à jour ici
}

// Initialisation au chargement
document.addEventListener('DOMContentLoaded', initOverlay);

// Exemple de fonction pour ajouter des éléments dynamiques
function addElement(type, content) {
    const element = document.createElement(type);
    element.textContent = content;
    document.getElementById('overlay-container').appendChild(element);
}`
        };
        this.init();
      }

      init() {
        console.log("Initialisation de l'éditeur d'overlay");
        
        // Attendre que le DOM et CodeMirror soient chargés
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => this.setupEditors(), 100);
            this.setupEventListeners();
            this.loadOverlayData();
          });
        } else {
          setTimeout(() => this.setupEditors(), 100);
          this.setupEventListeners();
          this.loadOverlayData();
        }
      }

      setupEditors() {
        console.log("Configuration des éditeurs CodeMirror");
        
        // Configuration pour chaque éditeur
        const editorConfig = {
          html: {
            mode: 'htmlmixed',
            theme: 'dracula',
            lineNumbers: true,
            autoCloseTags: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            matchTags: {bothTags: true},
            indentUnit: 2,
            tabSize: 2,
            lineWrapping: true
          },
          css: {
            mode: 'css',
            theme: 'dracula',
            lineNumbers: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            indentUnit: 2,
            tabSize: 2,
            lineWrapping: true
          },
          js: {
            mode: 'javascript',
            theme: 'dracula',
            lineNumbers: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            indentUnit: 2,
            tabSize: 2,
            lineWrapping: true
          }
        };

        // Initialiser chaque éditeur
        ['html', 'css', 'js'].forEach(type => {
          const textarea = document.getElementById(`${type}-editor`);
          if (textarea) {
            this.editors[type] = CodeMirror.fromTextArea(textarea, {
              ...editorConfig[type],
              value: this.files[type]
            });
            
            // Ajouter l'écouteur d'événements pour les modifications
            this.editors[type].on('change', () => {
              this.files[type] = this.editors[type].getValue();
              this.updatePreview();
            });
          }
        });

        // Afficher l'éditeur HTML par défaut
        this.showEditor('html');
      }

      showEditor(type) {
        // Cacher tous les éditeurs
        Object.keys(this.editors).forEach(key => {
          if (this.editors[key]) {
            this.editors[key].getWrapperElement().style.display = 'none';
          }
        });

        // Afficher l'éditeur sélectionné
        if (this.editors[type]) {
          this.editors[type].getWrapperElement().style.display = 'block';
          this.editors[type].refresh();
          this.currentTab = type;
        }
      }

      switchTab(tab) {
        console.log("Changement d'onglet vers:", tab);
        
        // Mettre à jour les onglets actifs
        document.querySelectorAll('.editor-tab.active, .file-item.active').forEach(el => {
          el.classList.remove('active');
        });
        
        // Activer les nouveaux onglets
        const editorTab = document.querySelector(`.editor-tab[data-tab="${tab}"]`);
        const fileItem = document.querySelector(`.file-item[data-tab="${tab}"]`);
        
        if (editorTab) editorTab.classList.add('active');
        if (fileItem) fileItem.classList.add('active');

        // Afficher l'éditeur correspondant
        this.showEditor(tab);
      }

      loadOverlayData() {
        console.log("Chargement des données de l'overlay");
        
        // Essayer de charger un overlay existant ou en créer un nouveau
        const loaded = this.loadExistingOverlay();
        if (!loaded) {
          console.log("Aucun overlay existant trouvé, création d'un nouveau");
          this.createNewOverlay();
        }
        
        // S'assurer que l'éditeur est correctement initialisé
        setTimeout(() => {
          if (this.editors['html']) {
            console.log("Rafraîchissement final de l'éditeur");
            this.editors['html'].refresh();
            this.updatePreview();
          }
        }, 300);
      }

      loadExistingOverlay() {
        const params = new URLSearchParams(window.location.search);
        const overlayId = params.get('id');

        if (overlayId) {
          const overlayData = localStorage.getItem(`overlay_${overlayId}`);
          if (overlayData) {
            const overlay = JSON.parse(overlayData);
            this.overlayId = overlayId;
            this.overlayName = overlay.name;
            this.files = overlay.files;

            document.getElementById('overlayName').value = this.overlayName;
            if (this.editors['html']) {
              this.editors['html'].setValue(this.files['html']);
            }
            this.updatePreview();
            return true;
          }
        }
        return false;
      }

      createNewOverlay() {
        this.overlayId = this.generateOverlayId();
        this.overlayName = 'Mon Nouvel Overlay';
        document.getElementById('overlayName').value = this.overlayName;

        // Définir le contenu de l'éditeur avec le fichier actuel
        console.log("Initialisation de l'éditeur avec le contenu HTML");
        if (this.editors['html']) {
          this.editors['html'].setValue(this.files['html']);
        }
        
        // Mettre à jour l'aperçu
        this.updatePreview();
      }

      generateOverlayId() {
        return 'overlay_' + Math.random().toString(36).substr(2, 9);
      }

      generateOverlayUrl() {
        // Sauvegarder le contenu actuel
        if (this.editors['html']) {
          this.files['html'] = this.editors['html'].getValue();
        }
        
        // Construire l'URL absolue
        const currentPath = window.location.pathname;
        const basePath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1);
        const baseUrl = `${window.location.origin}${basePath}overlay.html`;
        
        // Créer l'URL avec les paramètres encodés
        const url = new URL(baseUrl);
        url.searchParams.append('id', this.overlayId);
        url.searchParams.append('name', encodeURIComponent(this.overlayName));
        url.searchParams.append('html', encodeURIComponent(this.files['html']));
        url.searchParams.append('css', encodeURIComponent(this.files['css'] || ''));
        url.searchParams.append('js', encodeURIComponent(this.files['js'] || ''));
        
        return url.toString();
      }

      copyOverlayUrl() {
        const url = this.generateOverlayUrl();
        navigator.clipboard.writeText(url).then(() => {
          this.showToast('URL copiée dans le presse-papier !');
          console.log('URL copiée:', url);
        }).catch(() => {
          this.showToast('Erreur lors de la copie de l\'URL');
        });
      }

      updatePreview() {
        console.log("Mise à jour de l'aperçu");
        
        // Sauvegarder le contenu actuel de l'éditeur
        if (this.currentTab && this.editors[this.currentTab]) {
          this.files[this.currentTab] = this.editors[this.currentTab].getValue();
        }
        
        // Récupérer l'iframe
        const frame = document.getElementById('preview-frame');
        
        // Créer le contenu HTML pour l'aperçu
        const content = `
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <style>
                body {
                  margin: 0;
                  padding: 0;
                  overflow: hidden;
                  background: transparent;
                }
                ${this.files['css'] || ''}
              </style>
          </head>
          <body>
              ${this.files['html'] || ''}
              <script>
                try {
                  ${this.files['js'] || ''}
                } catch(e) {
                  console.error('Erreur dans le script:', e);
                }
              <\/script>
          </body>
          </html>`;
          
        // Mettre à jour l'iframe
        frame.srcdoc = content;
        
        console.log("Aperçu mis à jour");
      }

      async saveOverlay() {
        try {
          // Sauvegarder le contenu actuel de l'éditeur
          if (this.editors['html']) {
            this.files['html'] = this.editors['html'].getValue();
          }
          
          // Créer l'objet overlay
          const overlay = {
            id: this.overlayId,
            name: this.overlayName || 'Overlay sans nom',
            files: this.files,
            createdAt: new Date().toISOString()
          };

          // Sauvegarder dans localStorage pour l'éditeur
          localStorage.setItem(`overlay_${this.overlayId}`, JSON.stringify(overlay));

          // Sauvegarder dans la bibliothèque d'overlays
          let myOverlays = JSON.parse(localStorage.getItem('my_overlays') || '[]');
          
          // Vérifier si l'overlay existe déjà
          const existingIndex = myOverlays.findIndex(o => o.id === this.overlayId);
          
          if (existingIndex >= 0) {
            // Mettre à jour l'overlay existant
            myOverlays[existingIndex] = overlay;
          } else {
            // Ajouter un nouvel overlay
            myOverlays.push(overlay);
          }
          
          // Sauvegarder la liste mise à jour
          localStorage.setItem('my_overlays', JSON.stringify(myOverlays));

          this.showToast('Overlay sauvegardé avec succès !');
          console.log('Overlay sauvegardé:', overlay);
          
        } catch (error) {
          console.error('Erreur lors de la sauvegarde:', error);
          this.showToast('Erreur lors de la sauvegarde de l\'overlay');
        }
      }

      showToast(message) {
        const toast = document.getElementById('toast');
        toast.querySelector('span').textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
      }
    }

    // Initialiser l'éditeur quand la page est chargée
    console.log("Démarrage de l'éditeur d'overlay");
    const editor = new OverlayEditor();
  </script>
</body>
</html>
