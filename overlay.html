<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APO Overlay</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #9146FF;
            --secondary: #00ADB5;
            --background: #0e0e10;
            --surface: #18181b;
            --text: #efeff1;
            --text-secondary: #adadb8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: transparent;
            color: var(--text);
            width: 1920px;
            height: 1080px;
            overflow: hidden;
            position: relative;
        }
        
        /* Ces styles sont commentés pour ne pas afficher le cadre en production */
        /*
        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid rgba(145, 70, 255, 0.5);
            pointer-events: none;
            z-index: 9999;
            box-sizing: border-box;
        }
        
        body::after {
            content: "1920 x 1080";
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(145, 70, 255, 0.7);
            color: white;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            z-index: 9999;
        }
        */

        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div id="overlay-container"></div>

    <script>
        class OverlayLoader {
            constructor() {
                this.container = document.getElementById('overlay-container');
                this.init();
            }

            init() {
                const params = new URLSearchParams(window.location.search);
                const overlayId = params.get('id');

                if (!overlayId) {
                    this.showError("Aucun ID d'overlay spécifié");
                    return;
                }

                this.loadOverlay(overlayId);
            }

            loadOverlay(overlayId) {
                try {
                    console.log("Tentative de chargement de l'overlay avec ID:", overlayId);
                    
                    // Vérifier si des paramètres d'overlay sont présents dans l'URL
                    const params = new URLSearchParams(window.location.search);
                    const htmlContent = params.get('html');
                    const cssContent = params.get('css');
                    const jsContent = params.get('js');
                    const overlayName = params.get('name') || 'Mon Overlay';
                    
                    // Si les paramètres sont présents dans l'URL, les utiliser directement
                    if (htmlContent && cssContent) {
                        console.log("Chargement de l'overlay depuis les paramètres d'URL");
                        
                        // Créer le document HTML avec le contenu des paramètres
                        const content = `
                            <!DOCTYPE html>
                            <html>
                            <head>
                                <meta charset="UTF-8">
                                <title>${overlayName}</title>
                                <style>
                                    body {
                                        margin: 0;
                                        padding: 0;
                                        overflow: hidden;
                                        background: transparent;
                                    }
                                    ${decodeURIComponent(cssContent)}
                                </style>
                            </head>
                            <body>
                                ${decodeURIComponent(htmlContent)}
                                <script>${jsContent ? decodeURIComponent(jsContent) : ''}<\/script>
                            </body>
                            </html>
                        `;
                        
                        // Remplacer le contenu du document
                        document.documentElement.innerHTML = content;
                        console.log("Overlay chargé avec succès depuis les paramètres d'URL");
                        return;
                    }
                    
                    // Sinon, essayer de charger depuis localStorage
                    const overlayData = localStorage.getItem(`overlay_${overlayId}`);
                    console.log("Données d'overlay trouvées dans localStorage:", overlayData ? "Oui" : "Non");
                    
                    if (!overlayData) {
                        // Si l'overlay n'est pas trouvé, afficher un message d'erreur détaillé
                        console.error("Overlay non trouvé dans localStorage. ID recherché:", overlayId);
                        
                        // Lister tous les éléments du localStorage pour le débogage
                        const allKeys = [];
                        for (let i = 0; i < localStorage.length; i++) {
                            allKeys.push(localStorage.key(i));
                        }
                        console.log("Clés disponibles dans localStorage:", allKeys);
                        
                        this.showError(`Overlay non trouvé (ID: ${overlayId}). Utilisez l'URL complète générée par l'éditeur.`);
                        return;
                    }
                    
                    // Analyser les données JSON
                    const overlay = JSON.parse(overlayData);
                    console.log("Overlay chargé:", overlay);
                    
                    if (!overlay || !overlay.files) {
                        console.error("Format d'overlay invalide:", overlay);
                        this.showError("Format d'overlay invalide");
                        return;
                    }

                    // Créer le document HTML avec le contenu de l'overlay
                    const content = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <meta charset="UTF-8">
                            <title>${overlay.name}</title>
                            <style>
                                body {
                                    margin: 0;
                                    padding: 0;
                                    overflow: hidden;
                                    background: transparent;
                                }
                                ${overlay.files.css}
                            </style>
                        </head>
                        <body>
                            ${overlay.files.html}
                            <script>${overlay.files.js}<\/script>
                        </body>
                        </html>
                    `;
                    
                    // Remplacer le contenu du document
                    document.documentElement.innerHTML = content;
                    console.log("Overlay chargé avec succès depuis localStorage");
                    
                } catch (error) {
                    console.error('Erreur lors du chargement de l\'overlay:', error);
                    this.showError(`Erreur: ${error.message}`);
                }
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = message;
                document.body.appendChild(errorDiv);
            }
        }

        // Initialiser le chargeur d'overlay
        new OverlayLoader();
    </script>
</body>
</html>