<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configuration - Followers Goal</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 24px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
    }

    input[type="number"], input[type="text"], select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }

    input[type="number"]:focus, input[type="text"]:focus, select:focus {
      outline: none;
      border-color: #9146FF;
    }

    input[type="color"] {
      width: 60px;
      height: 40px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .color-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .preview {
      background: #f8f9fa;
      border: 2px dashed #dee2e6;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }

    .preview-widget {
      display: inline-block;
      padding: 15px 25px;
      border-radius: 10px;
      font-weight: bold;
      min-width: 200px;
    }

    .buttons {
      display: flex;
      gap: 10px;
      margin-top: 30px;
    }

    button {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #9146FF 0%, #00D4AA 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(145, 70, 255, 0.3);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .current-info {
      background: #e3f2fd;
      border: 1px solid #2196f3;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .current-info h3 {
      color: #1976d2;
      margin-bottom: 10px;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .manual-controls {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .manual-controls h3 {
      color: #856404;
      margin-bottom: 10px;
    }

    .manual-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .btn-small {
      padding: 8px 15px;
      font-size: 14px;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #4caf50;
      color: white;
      padding: 12px 20px;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      opacity: 0;
      transform: translateY(-20px);
      transition: opacity 0.3s, transform 0.3s;
    }
    
    .obs-url-container {
      background: #e8f5e9;
      border: 1px solid #4caf50;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
    }
    
    .obs-actions {
      margin-top: 10px;
      display: flex;
      align-items: center;
    }
    
    .obs-actions button {
      background-color: #4caf50;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .obs-actions button:hover {
      background-color: #388e3c;
    }
    
    .help-text {
      margin-left: 10px;
      font-size: 12px;
      color: #666;
    }
    
    .obs-url-container h3 {
      color: #2e7d32;
      margin-bottom: 10px;
    }
    
    .url-box {
      display: flex;
      margin-top: 10px;
    }
    
    .url-box input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px 0 0 4px;
      font-size: 14px;
    }
    
    .url-box button {
      padding: 8px 15px;
      background-color: #17a2b8;
      color: white;
      border: none;
      border-radius: 0 4px 4px 0;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .url-box button:hover {
      background-color: #138496;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéØ Configuration Followers Goal</h1>
    
    <div class="current-info">
      <h3>üìä Informations actuelles</h3>
      <div class="info-item">
        <span>Followers actuels:</span>
        <span id="current-followers">-</span>
      </div>
      <div class="info-item">
        <span>Objectif:</span>
        <span id="current-goal">-</span>
      </div>
      <div class="info-item">
        <span>Progression:</span>
        <span id="current-progress">-</span>
      </div>
    </div>

    <div class="manual-controls">
      <h3>üîß Contr√¥les manuels (pour test)</h3>
      <p>Ajustez manuellement le nombre de followers pour tester l'overlay:</p>
      <div class="manual-buttons">
        <button class="btn-secondary btn-small" onclick="adjustFollowers(-1)">-1</button>
        <button class="btn-secondary btn-small" onclick="adjustFollowers(-10)">-10</button>
        <button class="btn-secondary btn-small" onclick="adjustFollowers(1)">+1</button>
        <button class="btn-secondary btn-small" onclick="adjustFollowers(10)">+10</button>
      </div>
    </div>

    <form id="config-form">
      <div class="form-group">
        <label for="goal">üéØ Objectif de followers:</label>
        <input type="number" id="goal" min="1" max="100000" value="1000" required>
      </div>

      <div class="form-group">
        <label for="title">üìù Titre personnalis√©:</label>
        <input type="text" id="title" value="Objectif Followers" maxlength="50">
      </div>

      <div class="form-group">
        <label for="style">üé® Style d'affichage:</label>
        <select id="style">
          <option value="modern">Moderne</option>
          <option value="classic">Classique</option>
          <option value="minimal">Minimal</option>
          <option value="neon">N√©on</option>
        </select>
      </div>

      <div class="form-group">
        <label>üåà Couleurs:</label>
        <div class="color-group">
          <label for="bg-color">Arri√®re-plan:</label>
          <input type="color" id="bg-color" value="#9146FF">
        </div>
      </div>

      <div class="form-group">
        <div class="color-group">
          <label for="text-color">Texte:</label>
          <input type="color" id="text-color" value="#FFFFFF">
        </div>
      </div>

      <div class="form-group">
        <div class="color-group">
          <label for="progress-color">Barre de progression:</label>
          <input type="color" id="progress-color" value="#00D4AA">
        </div>
      </div>

      <div class="preview">
        <h3>üëÄ Aper√ßu</h3>
        <div id="preview-widget" class="preview-widget">
          Objectif Followers: 850/1000 (85%)
        </div>
      </div>
      
      <div class="obs-url-container">
        <h3>üìã URL pour OBS</h3>
        <p>Copiez cette URL et utilisez-la comme source de navigateur dans OBS :</p>
        <div class="url-box">
          <input type="text" id="obs-url-input" readonly>
          <button class="btn-secondary btn-small" onclick="copyObsUrl()">Copier</button>
        </div>
        <div class="obs-actions">
          <button class="btn-primary btn-small" onclick="updateObsUrl()">Synchroniser OBS</button>
          <span class="help-text">Cliquez pour mettre √† jour l'URL avec les derni√®res valeurs</span>
        </div>
        <p class="mt-2"><small>Note: Cette URL contient tous vos param√®tres de configuration actuels. Utilisez le bouton "Synchroniser OBS" pour mettre √† jour le widget sans avoir √† copier-coller l'URL √† nouveau.</small></p>
      </div>

      <div class="buttons">
        <button type="button" class="btn-secondary" onclick="resetConfig()">R√©initialiser</button>
        <button type="submit" class="btn-primary">Sauvegarder</button>
      </div>
    </form>
  </div>

  <script>
    // Charger la configuration existante
    async function loadConfig() {
      const config = JSON.parse(localStorage.getItem('followers_goal_config') || '{}');
      
      document.getElementById('goal').value = config.goal || 1000;
      document.getElementById('title').value = config.title || 'Objectif Followers';
      document.getElementById('style').value = config.style || 'modern';
      document.getElementById('bg-color').value = config.bgColor || '#9146FF';
      document.getElementById('text-color').value = config.textColor || '#FFFFFF';
      document.getElementById('progress-color').value = config.progressColor || '#00D4AA';
      
      // Tenter de r√©cup√©rer le nombre r√©el de followers depuis l'API Twitch
      let currentFollowers = await fetchCurrentFollowers();
      
      // Si la r√©cup√©ration a √©chou√©, utiliser la valeur en cache
      if (currentFollowers === null) {
        currentFollowers = localStorage.getItem('current_followers_count') || '0';
      } else {
        // Mettre √† jour le cache avec la nouvelle valeur
        localStorage.setItem('current_followers_count', currentFollowers.toString());
      }
      
      // Mettre √† jour les informations actuelles (fonction asynchrone)
      await updateCurrentInfo();
      // Mettre √† jour l'aper√ßu une fois les informations actualis√©es
      updatePreview();
    }
    
    async function fetchCurrentFollowers() {
      try {
        const token = localStorage.getItem('twitch_token');
        const userData = localStorage.getItem('twitch_user');
        
        if (!token || !userData) {
          console.error('Token ou donn√©es utilisateur manquants');
          return null;
        }

        try {
          const user = JSON.parse(userData);
          if (!user || !user.id) {
            console.error('Donn√©es utilisateur invalides:', userData);
            return null;
          }
          
          const broadcasterId = user.id;
          console.log('R√©cup√©ration des followers pour l\'ID:', broadcasterId);

          // Utiliser l'API Twitch pour r√©cup√©rer le nombre de followers
          // L'API a chang√©: https://dev.twitch.tv/docs/api/reference/#get-channel-followers
          const response = await fetch(`https://api.twitch.tv/helix/channels/followers?broadcaster_id=${broadcasterId}`, {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Client-Id': 'z8q1w4g12yrql6cyb5zzwmhe1pnxyn'
            }
          });

          if (response.ok) {
            const data = await response.json();
            console.log('Donn√©es de followers r√©cup√©r√©es:', data);
            
            // V√©rifier la structure de la r√©ponse pour s'adapter aux changements d'API
            if (data && typeof data.total === 'number') {
              // Format ancien de l'API: { total: X, data: [...], pagination: {...} }
              console.log('Nombre de followers depuis total:', data.total);
              return data.total;
            } else if (data && data.total_count !== undefined) {
              // Nouveau format possible: { total_count: X, data: [...], pagination: {...} }
              console.log('Nombre de followers depuis total_count:', data.total_count);
              return data.total_count;
            } else if (data && data.data && Array.isArray(data.data)) {
              // Si l'API a chang√© et ne renvoie plus le total directement
              if (data.data.length > 0 && data.data[0].follower_count !== undefined) {
                // Format possible: { data: [{ follower_count: X }] }
                console.log('Nombre de followers depuis follower_count:', data.data[0].follower_count);
                return data.data[0].follower_count;
              } else if (data.data.length > 0 && data.data[0].followed_at) {
                // Compter les followers dans la r√©ponse pagin√©e (moins pr√©cis)
                // Mais l'API actuelle limite √† 100 r√©sultats par page
                console.log('Nombre de followers estim√© depuis la longueur des donn√©es (limit√©):', data.data.length);
                console.warn('Attention: Ce nombre est limit√© par la pagination de l\'API et peut √™tre inexact');
                return data.data.length;
              } else {
                // Aucune donn√©e de followers trouv√©e
                console.warn('Aucune donn√©e de followers trouv√©e dans la r√©ponse API');
                return null;
              }
            } else {
              // Fallback si l'API ne renvoie pas les donn√©es attendues
              console.warn('Format de r√©ponse API non reconnu:', data);
              return null;
            }
          } else {
            console.error('Erreur lors de la r√©cup√©ration des followers:', response.status, response.statusText);
            // Essayer d'extraire plus d'informations sur l'erreur
            try {
              const errorData = await response.json();
              console.error('D√©tails de l\'erreur:', errorData);
              
              // V√©rifier si le token est expir√©
              if (response.status === 401 || 
                  (errorData && errorData.message && errorData.message.includes('token'))) {
                console.error('Le token d\'authentification semble √™tre expir√© ou invalide');
              }
            } catch (e) {
              console.error('Impossible de lire les d√©tails de l\'erreur');
            }
            return null;
          }
        } catch (parseError) {
          console.error('Erreur lors du traitement des donn√©es utilisateur:', parseError);
          console.error('Donn√©es utilisateur brutes:', userData);
          return null;
        }
      } catch (error) {
        console.error('Erreur lors de la r√©cup√©ration des followers:', error);
        return null;
      }
    }

    // Mettre √† jour les informations actuelles
    async function updateCurrentInfo() {
      // Tenter de r√©cup√©rer le nombre r√©el de followers depuis l'API Twitch
      let currentFollowers = await fetchCurrentFollowers();
      
      // Si la r√©cup√©ration a √©chou√©, utiliser la valeur en cache
      if (currentFollowers === null) {
        currentFollowers = localStorage.getItem('current_followers_count') || '0';
      } else {
        // Mettre √† jour le cache avec la nouvelle valeur
        localStorage.setItem('current_followers_count', currentFollowers.toString());
      }
      
      const config = JSON.parse(localStorage.getItem('followers_goal_config') || '{}');
      const goal = config.goal || 1000;
      const progress = Math.min(100, Math.round((parseInt(currentFollowers) / goal) * 100));
      
      document.getElementById('current-followers').textContent = currentFollowers;
      document.getElementById('current-goal').textContent = goal;
      document.getElementById('current-progress').textContent = progress + '%';
    }

    // Ajuster manuellement les followers (uniquement pour les tests)
    async function adjustFollowers(amount) {
      // R√©cup√©rer d'abord le nombre r√©el de followers
      let currentFollowers = await fetchCurrentFollowers();
      
      // Si la r√©cup√©ration a √©chou√©, utiliser la valeur en cache
      if (currentFollowers === null) {
        currentFollowers = parseInt(localStorage.getItem('current_followers_count') || '0');
      }
      
      // Ajuster la valeur (uniquement pour les tests)
      const newValue = Math.max(0, currentFollowers + amount);
      localStorage.setItem('current_followers_count', newValue.toString());
      
      // Mettre √† jour l'affichage
      await updateCurrentInfo();
      updatePreview();
      
      // Notification de mise √† jour
      showNotification('Nombre de followers mis √† jour');
    }
    
    // Afficher une notification temporaire
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.textContent = message;
      document.body.appendChild(notification);
      
      // Animation d'entr√©e
      setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateY(0)';
      }, 10);
      
      // Disparition apr√®s 3 secondes
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateY(-20px)';
        
        // Supprimer l'√©l√©ment apr√®s la fin de l'animation
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 500);
      }, 3000);
    }

    // Mettre √† jour l'aper√ßu
    function updatePreview() {
      const goal = document.getElementById('goal').value;
      const title = document.getElementById('title').value;
      const style = document.getElementById('style').value;
      const bgColor = document.getElementById('bg-color').value;
      const textColor = document.getElementById('text-color').value;
      const progressColor = document.getElementById('progress-color').value;
      const currentFollowers = localStorage.getItem('current_followers_count') || '0';
      const progress = Math.min(100, Math.round((parseInt(currentFollowers) / goal) * 100));
      
      const preview = document.getElementById('preview-widget');
      preview.textContent = `${title}: ${currentFollowers}/${goal} (${progress}%)`;
      preview.style.backgroundColor = bgColor;
      preview.style.color = textColor;
      
      // G√©n√©rer l'URL pour OBS avec un timestamp pour √©viter la mise en cache
      const baseUrl = window.location.href.split('?')[0].replace('config.html', 'overlay.html');
      const timestamp = Date.now(); // Ajouter un timestamp pour forcer le rafra√Æchissement
      const obsUrl = `${baseUrl}?obs=true&goal=${goal}&title=${encodeURIComponent(title)}&style=${style}&bgColor=${encodeURIComponent(bgColor)}&textColor=${encodeURIComponent(textColor)}&progressColor=${encodeURIComponent(progressColor)}&current=${currentFollowers}&t=${timestamp}`;
      
      // Mettre √† jour le champ d'URL OBS
      const obsUrlInput = document.getElementById('obs-url-input');
      if (obsUrlInput) {
        obsUrlInput.value = obsUrl;
      }
    }

    // R√©initialiser la configuration
    async function resetConfig() {
      if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser la configuration ?')) {
        localStorage.removeItem('followers_goal_config');
        await loadConfig();
      }
    }

    // Sauvegarder la configuration
    document.getElementById('config-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const config = {
        goal: parseInt(document.getElementById('goal').value),
        title: document.getElementById('title').value,
        style: document.getElementById('style').value,
        bgColor: document.getElementById('bg-color').value,
        textColor: document.getElementById('text-color').value,
        progressColor: document.getElementById('progress-color').value
      };
      
      localStorage.setItem('followers_goal_config', JSON.stringify(config));
      localStorage.setItem('followers_goal', config.goal);
      
      // Sauvegarder √©galement le nombre actuel de followers pour assurer la coh√©rence
      const currentFollowers = document.getElementById('current-followers').textContent;
      if (currentFollowers && !isNaN(parseInt(currentFollowers))) {
        localStorage.setItem('current_followers_count', currentFollowers);
      }
      
      // Mettre √† jour l'URL OBS apr√®s la sauvegarde
      updatePreview();
      
      // Afficher un message de confirmation
      const saveBtn = document.querySelector('button[type="submit"]');
      const originalText = saveBtn.textContent;
      saveBtn.textContent = 'Sauvegard√© ‚úì';
      saveBtn.style.backgroundColor = '#4caf50';
      
      setTimeout(() => {
        saveBtn.textContent = originalText;
        saveBtn.style.backgroundColor = '';
        // Fermer la fen√™tre apr√®s un court d√©lai
        window.close();
      }, 2000);
    });

    // Mettre √† jour l'aper√ßu en temps r√©el
    document.querySelectorAll('input, select').forEach(element => {
      element.addEventListener('input', updatePreview);
    });
    
    // Fonction pour copier l'URL OBS dans le presse-papier
    function copyObsUrl() {
      const urlInput = document.getElementById('obs-url-input');
      if (urlInput) {
        urlInput.select();
        document.execCommand('copy');
        
        // Feedback visuel
        const button = document.querySelector('.url-box button');
        const originalText = button.textContent;
        button.textContent = 'Copi√© ‚úì';
        button.style.backgroundColor = '#4caf50';
        
        setTimeout(() => {
          button.textContent = originalText;
          button.style.backgroundColor = '';
        }, 2000);
      }
    }
    
    // Fonction pour mettre √† jour l'URL OBS et forcer une synchronisation
    function updateObsUrl() {
      // Mettre √† jour l'aper√ßu pour g√©n√©rer une nouvelle URL avec timestamp
      updatePreview();
      
      // R√©cup√©rer l'URL g√©n√©r√©e
      const obsUrl = document.getElementById('obs-url-input').value;
      
      // Cr√©er un iframe temporaire pour charger l'URL (cela force OBS √† recharger le widget)
      const tempFrame = document.createElement('iframe');
      tempFrame.style.width = '1px';
      tempFrame.style.height = '1px';
      tempFrame.style.position = 'absolute';
      tempFrame.style.left = '-9999px';
      tempFrame.src = obsUrl;
      
      document.body.appendChild(tempFrame);
      
      // Supprimer l'iframe apr√®s le chargement
      tempFrame.onload = function() {
        setTimeout(() => {
          document.body.removeChild(tempFrame);
        }, 1000);
      };
      
      // Afficher une notification
      showNotification('Widget OBS synchronis√©');
    }

    // Charger la configuration au d√©marrage
    document.addEventListener('DOMContentLoaded', () => {
      loadConfig();
    });
  </script>
</body>
</html>