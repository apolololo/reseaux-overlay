<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Followers Goal Overlay</title>
  <link rel="stylesheet" href="./overlay.css">
</head>
<body>
  <div class="followers-goal-container">
    <div class="goal-header">
      <h2 class="goal-title">Objectif Followers</h2>
    </div>
    
    <div class="followers-info">
      <div class="current-followers">
        <span class="followers-count" id="current-count">0</span>
        <span class="followers-label">Followers</span>
      </div>
      
      <div class="goal-separator">/</div>
      
      <div class="goal-followers">
        <span class="goal-count" id="goal-count">1000</span>
        <span class="goal-label">Objectif</span>
      </div>
    </div>
    
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <div class="progress-percentage" id="progress-percentage">0%</div>
    </div>
    
    <div class="remaining-info">
      <span class="remaining-text">Plus que <span id="remaining-count">1000</span> followers !</span>
    </div>
  </div>

  <script>
    class FollowersGoal {
      constructor() {
        this.currentFollowers = 0;
        this.goalFollowers = 1000;
        this.init();
      }
      
      applyStyles(config) {
        if (!config) return;
        
        console.log('Application des styles:', config);
        
        // Appliquer le titre personnalisé
        if (config.title) {
          const titleEl = document.querySelector('.goal-title');
          if (titleEl) titleEl.textContent = config.title;
        }
        
        // Appliquer les couleurs
        const container = document.querySelector('.followers-goal-container');
        if (container && config.bgColor) {
          container.style.background = config.bgColor;
        }
        
        if (config.textColor) {
          document.body.style.color = config.textColor;
        }
        
        if (config.progressColor) {
          const progressFill = document.getElementById('progress-fill');
          if (progressFill) {
            progressFill.style.background = config.progressColor;
          }
        }
        
        // Appliquer le style d'affichage
        if (config.style) {
          document.body.className = ''; // Réinitialiser les classes
          document.body.classList.add(`style-${config.style}`);
        }
      }

      init() {
        this.loadSettings();
        this.updateDisplay();
        this.startPolling();
      }

      loadSettings() {
        // Charger les paramètres depuis l'URL ou localStorage
        const urlParams = new URLSearchParams(window.location.search);
        const goal = urlParams.get('goal');
        const current = urlParams.get('current');
        
        // Charger la configuration complète depuis localStorage
        const configStr = localStorage.getItem('followers_goal_config');
        let config = {};
        
        if (configStr) {
          try {
            config = JSON.parse(configStr);
            console.log('Configuration chargée:', config);
          } catch (e) {
            console.error('Erreur lors du chargement de la configuration:', e);
          }
        } else {
          console.log('Aucune configuration trouvée dans localStorage');
        }
        
        // Priorité aux paramètres d'URL, puis config, puis valeurs par défaut
        if (goal) {
          this.goalFollowers = parseInt(goal);
        } else if (config.goal) {
          this.goalFollowers = config.goal;
        } else {
          const savedGoal = localStorage.getItem('followers_goal');
          if (savedGoal) {
            this.goalFollowers = parseInt(savedGoal);
          }
        }
        
        if (current) {
          this.currentFollowers = parseInt(current);
        }
        
        // Appliquer les styles de la configuration
        if (config) {
          this.applyStyles(config);
        }
      }

      async fetchFollowersCount() {
        try {
          const token = localStorage.getItem('twitch_token');
          const userData = localStorage.getItem('twitch_user');
          
          if (!token || !userData) {
            console.error('Token ou données utilisateur manquants');
            // Utiliser les données en cache si disponibles
            const savedFollowers = localStorage.getItem('current_followers_count');
            if (savedFollowers) {
              this.currentFollowers = parseInt(savedFollowers);
              console.log('Utilisation du nombre de followers en cache:', this.currentFollowers);
              this.updateDisplay();
            }
            return;
          }

          try {
            const user = JSON.parse(userData);
            if (!user || !user.id) {
              console.error('Données utilisateur invalides:', userData);
              return;
            }
            
            const broadcasterId = user.id;
            console.log('Récupération des followers pour l\'ID:', broadcasterId);

            // Utiliser l'API Twitch pour récupérer le nombre de followers
            // L'API a changé: https://dev.twitch.tv/docs/api/reference/#get-channel-followers
            const response = await fetch(`https://api.twitch.tv/helix/channels/followers?broadcaster_id=${broadcasterId}`, {
              headers: {
                'Authorization': `Bearer ${token}`,
                'Client-Id': 'z8q1w4g12yrql6cyb5zzwmhe1pnxyn'
              }
            });

            if (response.ok) {
              const data = await response.json();
              console.log('Données de followers récupérées:', data);
              
              // Vérifier la structure de la réponse pour s'adapter aux changements d'API
              if (data && typeof data.total === 'number') {
                // Format ancien de l'API: { total: X, data: [...], pagination: {...} }
                this.currentFollowers = data.total;
                console.log('Nombre de followers depuis total:', this.currentFollowers);
              } else if (data && data.total_count !== undefined) {
                // Nouveau format possible: { total_count: X, data: [...], pagination: {...} }
                this.currentFollowers = data.total_count;
                console.log('Nombre de followers depuis total_count:', this.currentFollowers);
              } else if (data && data.data && Array.isArray(data.data)) {
                // Si l'API a changé et ne renvoie plus le total directement
                if (data.data.length > 0 && data.data[0].follower_count !== undefined) {
                  // Format possible: { data: [{ follower_count: X }] }
                  this.currentFollowers = data.data[0].follower_count;
                  console.log('Nombre de followers depuis follower_count:', this.currentFollowers);
                } else if (data.data.length > 0 && data.data[0].followed_at) {
                  // Compter les followers dans la réponse paginée (moins précis)
                  // Mais l'API actuelle limite à 100 résultats par page
                  this.currentFollowers = data.data.length;
                  console.log('Nombre de followers estimé depuis la longueur des données (limité):', this.currentFollowers);
                  
                  // Avertissement sur la limitation
                  console.warn('Attention: Ce nombre est limité par la pagination de l\'API et peut être inexact');
                } else {
                  // Aucune donnée de followers trouvée
                  console.warn('Aucune donnée de followers trouvée dans la réponse API');
                  // Utiliser les données en cache
                  const savedFollowers = localStorage.getItem('current_followers_count');
                  if (savedFollowers) {
                    this.currentFollowers = parseInt(savedFollowers);
                    console.log('Utilisation du nombre de followers en cache (aucune donnée):', this.currentFollowers);
                  } else {
                    this.currentFollowers = 0;
                    console.log('Aucune donnée de followers disponible, utilisation de 0');
                  }
                }
              } else {
                // Fallback si l'API ne renvoie pas les données attendues
                console.warn('Format de réponse API non reconnu:', data);
                const savedFollowers = localStorage.getItem('current_followers_count');
                if (savedFollowers) {
                  this.currentFollowers = parseInt(savedFollowers);
                  console.log('Utilisation du nombre de followers de secours (cache):', this.currentFollowers);
                } else {
                  this.currentFollowers = 0;
                  console.log('Aucune donnée de followers disponible, utilisation de 0');
                }
              }
              
              // Sauvegarder et mettre à jour l'affichage
              localStorage.setItem('current_followers_count', this.currentFollowers.toString());
              this.updateDisplay();
            } else {
              console.error('Erreur lors de la récupération des followers:', response.status, response.statusText);
              // Essayer d'extraire plus d'informations sur l'erreur
              try {
                const errorData = await response.json();
                console.error('Détails de l\'erreur:', errorData);
                
                // Vérifier si le token est expiré
                if (response.status === 401 || 
                    (errorData && errorData.message && errorData.message.includes('token'))) {
                  console.error('Le token d\'authentification semble être expiré ou invalide');
                }
              } catch (e) {
                console.error('Impossible de lire les détails de l\'erreur');
              }
              
              // Utiliser les données en cache
              const savedFollowers = localStorage.getItem('current_followers_count');
              if (savedFollowers) {
                this.currentFollowers = parseInt(savedFollowers);
                console.log('Utilisation du nombre de followers en cache après erreur:', this.currentFollowers);
                this.updateDisplay();
              }
            }
          } catch (parseError) {
            console.error('Erreur lors du traitement des données utilisateur:', parseError);
            console.error('Données utilisateur brutes:', userData);
          }
        } catch (error) {
          console.error('Erreur lors de la récupération des followers:', error);
          
          // Utiliser les données en cache en cas d'erreur
          const savedFollowers = localStorage.getItem('current_followers_count');
          if (savedFollowers) {
            this.currentFollowers = parseInt(savedFollowers);
            console.log('Utilisation du nombre de followers en cache après exception:', this.currentFollowers);
            this.updateDisplay();
          }
        }
      }

      updateDisplay() {
        const currentCountEl = document.getElementById('current-count');
        const goalCountEl = document.getElementById('goal-count');
        const progressFillEl = document.getElementById('progress-fill');
        const progressPercentageEl = document.getElementById('progress-percentage');
        const remainingCountEl = document.getElementById('remaining-count');

        if (currentCountEl) currentCountEl.textContent = this.currentFollowers.toLocaleString();
        if (goalCountEl) goalCountEl.textContent = this.goalFollowers.toLocaleString();

        const percentage = Math.min((this.currentFollowers / this.goalFollowers) * 100, 100);
        const remaining = Math.max(this.goalFollowers - this.currentFollowers, 0);

        if (progressFillEl) {
          progressFillEl.style.width = `${percentage}%`;
        }
        
        if (progressPercentageEl) {
          progressPercentageEl.textContent = `${Math.round(percentage)}%`;
        }
        
        if (remainingCountEl) {
          remainingCountEl.textContent = remaining.toLocaleString();
        }

        // Masquer le texte "Plus que X followers" si l'objectif est atteint
        const remainingInfo = document.querySelector('.remaining-info');
        if (remainingInfo) {
          remainingInfo.style.display = remaining > 0 ? 'block' : 'none';
        }

        // Ajouter une classe spéciale si l'objectif est atteint
        const container = document.querySelector('.followers-goal-container');
        if (container) {
          if (this.currentFollowers >= this.goalFollowers) {
            container.classList.add('goal-reached');
          } else {
            container.classList.remove('goal-reached');
          }
        }
        
        // Sauvegarder le nombre actuel de followers pour la persistance
        localStorage.setItem('current_followers_count', this.currentFollowers.toString());
      }

      startPolling() {
        // Récupérer les followers immédiatement
        this.fetchFollowersCount();
        
        // Puis toutes les 30 secondes
        setInterval(() => {
          this.fetchFollowersCount();
        }, 30000);
        
        // Vérifier les changements de configuration toutes les 5 secondes
        this.lastConfigStr = localStorage.getItem('followers_goal_config') || '';
        
        setInterval(() => {
          const currentConfigStr = localStorage.getItem('followers_goal_config') || '';
          
          // Si la configuration a changé
          if (currentConfigStr !== this.lastConfigStr) {
            console.log('Configuration modifiée, rechargement des paramètres...');
            this.lastConfigStr = currentConfigStr;
            
            // Recharger les paramètres
            this.loadSettings();
            this.updateDisplay();
          }
        }, 5000);
      }
    }

    // Initialiser le widget quand la page est chargée
    document.addEventListener('DOMContentLoaded', () => {
      new FollowersGoal();
    });
  </script>
</body>
</html>