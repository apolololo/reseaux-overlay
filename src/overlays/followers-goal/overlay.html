<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Followers Goal Overlay</title>
  <link rel="stylesheet" href="./overlay.css">
</head>
<body>
  <div class="followers-goal-container">
    <div class="goal-header">
      <h2 class="goal-title">Objectif Followers</h2>
    </div>
    
    <div class="followers-info">
      <div class="current-followers">
        <span class="followers-count" id="current-count">0</span>
        <span class="followers-label">Followers</span>
      </div>
      
      <div class="goal-separator">/</div>
      
      <div class="goal-followers">
        <span class="goal-count" id="goal-count">1000</span>
        <span class="goal-label">Objectif</span>
      </div>
    </div>
    
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <div class="progress-percentage" id="progress-percentage">0%</div>
    </div>
    
    <div class="remaining-info">
      <span class="remaining-text">Plus que <span id="remaining-count">1000</span> followers !</span>
    </div>
  </div>

  <script>
    class FollowersGoal {
      constructor() {
        this.currentFollowers = 0;
        this.goalFollowers = 1000;
        this.init();
      }
      
      applyStyles(config) {
        if (!config) return;
        
        console.log('Application des styles:', config);
        
        // Appliquer le titre personnalisé
        if (config.title) {
          const titleEl = document.querySelector('.goal-title');
          if (titleEl) titleEl.textContent = config.title;
        }
        
        // Appliquer les couleurs
        const container = document.querySelector('.followers-goal-container');
        if (container && config.bgColor) {
          container.style.background = config.bgColor;
        }
        
        if (config.textColor) {
          document.body.style.color = config.textColor;
        }
        
        if (config.progressColor) {
          const progressFill = document.getElementById('progress-fill');
          if (progressFill) {
            progressFill.style.background = config.progressColor;
          }
        }
        
        // Appliquer le style d'affichage
        if (config.style) {
          document.body.className = ''; // Réinitialiser les classes
          document.body.classList.add(`style-${config.style}`);
        }
      }

      init() {
        this.loadSettings();
        this.updateDisplay();
        this.startPolling();
      }

      loadSettings() {
        // Charger les paramètres depuis l'URL ou localStorage
        const urlParams = new URLSearchParams(window.location.search);
        const isObs = urlParams.get('obs') === 'true';
        
        // Configuration par défaut
        let config = {
          goal: 1000,
          title: 'Objectif Followers',
          style: 'modern',
          bgColor: '#9146FF',
          textColor: '#FFFFFF',
          progressColor: '#00D4AA'
        };
        
        // Si nous sommes dans OBS, priorité aux paramètres d'URL
        if (isObs) {
          console.log('Mode OBS détecté, utilisation des paramètres d\'URL');
          
          // Récupérer tous les paramètres depuis l'URL
          const goal = urlParams.get('goal');
          const current = urlParams.get('current');
          const title = urlParams.get('title');
          const style = urlParams.get('style');
          const bgColor = urlParams.get('bgColor');
          const textColor = urlParams.get('textColor');
          const progressColor = urlParams.get('progressColor');
          
          // Mettre à jour la configuration avec les paramètres d'URL
          if (goal) config.goal = parseInt(goal);
          if (title) config.title = title;
          if (style) config.style = style;
          if (bgColor) config.bgColor = decodeURIComponent(bgColor);
          if (textColor) config.textColor = decodeURIComponent(textColor);
          if (progressColor) config.progressColor = decodeURIComponent(progressColor);
          
          // Mettre à jour les followers actuels
          if (current) {
            this.currentFollowers = parseInt(current);
            // Sauvegarder dans localStorage pour la cohérence
            localStorage.setItem('current_followers_count', this.currentFollowers.toString());
          }
          
          // Sauvegarder la configuration dans localStorage pour la cohérence
          localStorage.setItem('followers_goal_config', JSON.stringify(config));
        } else {
          // Mode normal (navigateur), charger depuis localStorage avec priorité aux paramètres d'URL
          const configStr = localStorage.getItem('followers_goal_config');
          
          if (configStr) {
            try {
              const savedConfig = JSON.parse(configStr);
              config = { ...config, ...savedConfig };
              console.log('Configuration chargée depuis localStorage:', config);
            } catch (e) {
              console.error('Erreur lors du chargement de la configuration:', e);
            }
          } else {
            console.log('Aucune configuration trouvée dans localStorage, utilisation des valeurs par défaut');
          }
          
          // Priorité aux paramètres d'URL
          const goal = urlParams.get('goal');
          const current = urlParams.get('current');
          
          if (goal) {
            this.goalFollowers = parseInt(goal);
          } else {
            this.goalFollowers = config.goal;
          }
          
          if (current) {
            this.currentFollowers = parseInt(current);
          }
        }
        
        // Définir l'objectif
        this.goalFollowers = config.goal || 1000;
        
        // Appliquer les styles de la configuration
        this.applyStyles(config);
        
        console.log('Configuration appliquée:', config);
        console.log('Objectif:', this.goalFollowers, 'Followers actuels:', this.currentFollowers);
      }

      async fetchFollowersCount() {
        // Vérifier si nous sommes en mode OBS
        const urlParams = new URLSearchParams(window.location.search);
        const isObs = urlParams.get('obs') === 'true';
        const currentParam = urlParams.get('current');
        
        // Si nous sommes en mode OBS et que le paramètre 'current' est fourni, l'utiliser directement
        if (isObs && currentParam) {
          console.log('Mode OBS: utilisation du nombre de followers depuis l\'URL:', currentParam);
          this.currentFollowers = parseInt(currentParam);
          this.updateDisplay();
          return;
        }
        
        try {
          // Vérifier si nous avons un token dans l'URL
          const tokenParam = urlParams.get('token');
          
          // Si pas de token dans l'URL, utiliser celui du localStorage
          const token = tokenParam || localStorage.getItem('twitch_token');
          
          if (!token) {
            console.warn('Aucun token Twitch trouvé, utilisation des données en cache');
            const cachedCount = localStorage.getItem('current_followers_count');
            if (cachedCount) {
              this.currentFollowers = parseInt(cachedCount);
              this.updateDisplay();
            }
            return;
          }
          
          // Récupérer l'ID du channel depuis localStorage
          const channelId = localStorage.getItem('channel_id');
          if (!channelId) {
            console.warn('ID du channel non trouvé, utilisation des données en cache');
            const cachedCount = localStorage.getItem('current_followers_count');
            if (cachedCount) {
              this.currentFollowers = parseInt(cachedCount);
              this.updateDisplay();
            }
            return;
          }
          
          // Appel à l'API Twitch
          const response = await fetch(`https://api.twitch.tv/helix/channels/followers?broadcaster_id=${channelId}`, {
            headers: {
              'Client-ID': '3hhpn0t1ixbm9xhxbj1h5g5l5yrqe3',
              'Authorization': `Bearer ${token}`
            }
          });
          
          if (!response.ok) {
            throw new Error(`Erreur API: ${response.status}`);
          }
          
          const data = await response.json();
          console.log('Données de l\'API Twitch:', data);
          
          // Adapter à la structure de réponse de l'API Twitch
          // L'API peut retourner soit data.total, soit data.data[0].follower_count
          if (data.total !== undefined) {
            this.currentFollowers = data.total;
          } else if (data.data && data.data[0] && data.data[0].follower_count !== undefined) {
            this.currentFollowers = data.data[0].follower_count;
          } else {
            console.warn('Format de réponse API inattendu, utilisation des données en cache');
            const cachedCount = localStorage.getItem('current_followers_count');
            if (cachedCount) {
              this.currentFollowers = parseInt(cachedCount);
            }
          }
          
          // Mettre à jour l'affichage
          this.updateDisplay();
          
          // Sauvegarder le nombre actuel dans localStorage
          localStorage.setItem('current_followers_count', this.currentFollowers.toString());
          
        } catch (error) {
          console.error('Erreur lors de la récupération du nombre de followers:', error);
          
          // En cas d'erreur, utiliser les données en cache
          const cachedCount = localStorage.getItem('current_followers_count');
          if (cachedCount) {
            this.currentFollowers = parseInt(cachedCount);
            this.updateDisplay();
          }
        }
      }

      updateDisplay() {
        const currentCountEl = document.getElementById('current-count');
        const goalCountEl = document.getElementById('goal-count');
        const progressFillEl = document.getElementById('progress-fill');
        const progressPercentageEl = document.getElementById('progress-percentage');
        const remainingCountEl = document.getElementById('remaining-count');

        if (currentCountEl) currentCountEl.textContent = this.currentFollowers.toLocaleString();
        if (goalCountEl) goalCountEl.textContent = this.goalFollowers.toLocaleString();

        const percentage = Math.min((this.currentFollowers / this.goalFollowers) * 100, 100);
        const remaining = Math.max(this.goalFollowers - this.currentFollowers, 0);

        if (progressFillEl) {
          progressFillEl.style.width = `${percentage}%`;
        }
        
        if (progressPercentageEl) {
          progressPercentageEl.textContent = `${Math.round(percentage)}%`;
        }
        
        if (remainingCountEl) {
          remainingCountEl.textContent = remaining.toLocaleString();
        }

        // Masquer le texte "Plus que X followers" si l'objectif est atteint
        const remainingInfo = document.querySelector('.remaining-info');
        if (remainingInfo) {
          remainingInfo.style.display = remaining > 0 ? 'block' : 'none';
        }

        // Ajouter une classe spéciale si l'objectif est atteint
        const container = document.querySelector('.followers-goal-container');
        if (container) {
          if (this.currentFollowers >= this.goalFollowers) {
            container.classList.add('goal-reached');
          } else {
            container.classList.remove('goal-reached');
          }
        }
        
        // Sauvegarder le nombre actuel de followers pour la persistance
        localStorage.setItem('current_followers_count', this.currentFollowers.toString());
      }

      startPolling() {
        // Vérifier si nous sommes en mode OBS
        const urlParams = new URLSearchParams(window.location.search);
        const isObs = urlParams.get('obs') === 'true';
        
        // Récupérer les followers immédiatement
        this.fetchFollowersCount();
        
        // Intervalle de mise à jour plus court pour une meilleure réactivité
        const updateInterval = isObs ? 3000 : 5000; // 3 secondes en mode OBS, 5 secondes en mode normal
        
        // Mettre en place le polling pour les mises à jour des followers
        setInterval(() => {
          // En mode OBS, vérifier si l'URL a changé
          if (isObs) {
            const newUrlParams = new URLSearchParams(window.location.search);
            const newCurrent = newUrlParams.get('current');
            
            if (newCurrent && parseInt(newCurrent) !== this.currentFollowers) {
              console.log('Mise à jour des followers depuis l\'URL:', newCurrent);
              this.currentFollowers = parseInt(newCurrent);
              this.updateDisplay();
            }
          } else {
            // En mode normal, récupérer les followers via l'API
            this.fetchFollowersCount();
          }
        }, updateInterval);
        
        // Vérifier les changements de configuration toutes les 2 secondes pour plus de réactivité
        setInterval(() => {
          // En mode OBS, vérifier si les paramètres d'URL ont changé
          if (isObs) {
            const newUrlParams = new URLSearchParams(window.location.search);
            const newGoal = newUrlParams.get('goal');
            const newTitle = newUrlParams.get('title');
            const newStyle = newUrlParams.get('style');
            const newBgColor = newUrlParams.get('bgColor');
            const newTextColor = newUrlParams.get('textColor');
            const newProgressColor = newUrlParams.get('progressColor');
            
            // Vérifier si un des paramètres a changé
            if ((newGoal && parseInt(newGoal) !== this.goalFollowers) ||
                (newTitle && newTitle !== this.config?.title) ||
                (newStyle && newStyle !== this.config?.style) ||
                (newBgColor && decodeURIComponent(newBgColor) !== this.config?.bgColor) ||
                (newTextColor && decodeURIComponent(newTextColor) !== this.config?.textColor) ||
                (newProgressColor && decodeURIComponent(newProgressColor) !== this.config?.progressColor)) {
              
              console.log('Paramètres d\'URL modifiés, rechargement...');
              this.loadSettings();
              this.updateDisplay();
            }
          } else {
            // En mode normal, vérifier les changements dans localStorage
            const configStr = localStorage.getItem('followers_goal_config');
            if (configStr) {
              try {
                const newConfig = JSON.parse(configStr);
                const currentConfig = JSON.stringify(this.config || {});
                
                // Si la configuration a changé, recharger les paramètres
                if (currentConfig !== JSON.stringify(newConfig)) {
                  console.log('Configuration modifiée, rechargement des paramètres');
                  this.config = newConfig;
                  this.loadSettings();
                  this.updateDisplay();
                }
              } catch (e) {
                console.error('Erreur lors de la vérification de la configuration:', e);
              }
            }
          }
        }, 2000);
        
        console.log(`Mode ${isObs ? 'OBS' : 'normal'}: polling configuré avec intervalle de ${updateInterval}ms`);
      }
    }

    // Initialiser le widget quand la page est chargée
    document.addEventListener('DOMContentLoaded', () => {
      new FollowersGoal();
    });
  </script>
</body>
</html>