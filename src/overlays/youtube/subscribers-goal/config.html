<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configuration Subscribers Goal - APO</title>
  <link rel="stylesheet" href="/src/styles/main.css">
  <link rel="stylesheet" href="/src/styles/app.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <parameter name="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    .config-container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
      background: var(--bg-dark);
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .config-section {
      margin-bottom: 2rem;
      background: var(--bg-darker);
      padding: 1.5rem;
      border-radius: 8px;
    }

    .config-section h2 {
      color: var(--primary);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-light);
      font-weight: 500;
    }

    .form-group input[type="number"],
    .form-group input[type="text"],
    .form-group input[type="color"] {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-dark);
      color: var(--text-light);
      font-family: 'Montserrat', sans-serif;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .preview-section {
      margin-top: 2rem;
      padding: 1.5rem;
      background: var(--bg-darker);
      border-radius: 8px;
    }

    .preview-container {
      width: 100%;
      height: 200px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
      background: var(--bg-dark);
    }

    .save-button {
      background: #FF0000;
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 6px;
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 1rem;
      transition: opacity 0.2s;
    }

    .save-button:hover {
      opacity: 0.9;
    }

    .save-success {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: #00D4AA;
      color: white;
      padding: 1rem 2rem;
      border-radius: 6px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
      z-index: 1000;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    .copy-link-container {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .copy-link-container input {
      flex: 1;
      padding: 10px;
      border: 2px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-dark);
      color: var(--text-light);
      font-family: 'Montserrat', sans-serif;
    }

    .copy-button {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 10px 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .copy-button:hover {
      background: var(--primary-dark);
    }

    .link-help {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="config-container">
    <h1>Configuration Subscribers Goal</h1>
    
    <div class="config-section">
      <h2>Objectif</h2>
      <div class="form-group">
        <label for="goal-target">Nombre d'abonnés cible</label>
        <input type="number" id="goal-target" min="1" value="1000">
      </div>
    </div>

    <div class="config-section">
      <h2>Personnalisation</h2>
      <div class="form-group">
        <label for="goal-text">Texte de l'objectif</label>
        <input type="text" id="goal-text" value="Objectif : {current}/{target} abonnés">
        <small style="color: #888; display: block; margin-top: 0.5rem;">
          Utilisez {current} pour le nombre actuel d'abonnés et {target} pour l'objectif
        </small>
      </div>
      <div class="form-group">
        <label for="progress-color">Couleur de la barre de progression</label>
        <input type="color" id="progress-color" value="#FF0000">
        <small style="color: #888; display: block; margin-top: 0.5rem;">
          Rouge YouTube par défaut (#FF0000)
        </small>
      </div>
      <div class="form-group">
        <label for="text-color">Couleur du texte</label>
        <input type="color" id="text-color" value="#FFFFFF">
      </div>
    </div>

    <div class="config-section">
      <h2>Visibilité</h2>
      <div class="checkbox-group">
        <input type="checkbox" id="show-background" checked>
        <label for="show-background">Afficher le fond</label>
      </div>
      <div class="checkbox-group">
        <input type="checkbox" id="show-progress-bar" checked>
        <label for="show-progress-bar">Afficher la barre de progression</label>
      </div>
      <div class="checkbox-group">
        <input type="checkbox" id="show-percentage" checked>
        <label for="show-percentage">Afficher le pourcentage</label>
      </div>
    </div>

    <div class="preview-section">
      <h3>Aperçu en direct</h3>
      <div class="preview-container">
        <iframe id="preview-frame" src="overlay.html"></iframe>
      </div>
    </div>

    <div class="config-section">
      <h2>Lien pour OBS</h2>
      <div class="form-group">
        <div class="copy-link-container">
          <input type="text" id="obs-link" readonly>
          <button id="copy-link" class="copy-button">
            <svg viewBox="0 0 24 24" width="18" height="18">
              <path fill="currentColor" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
            </svg>
            Copier
          </button>
        </div>
        <p class="link-help">Copiez ce lien et ajoutez-le comme source navigateur dans OBS</p>
      </div>
    </div>

    <button class="save-button" id="save-config">
      Enregistrer la configuration
    </button>
  </div>

  <script type="module">
    document.addEventListener('DOMContentLoaded', async () => {
      // Vérifier l'authentification
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');
      
      if (!token) {
        window.location.href = '/src/youtube-dashboard.html';
        return;
      }

      try {
        // Décoder les données YouTube
        const tokenData = JSON.parse(atob(token));
        const youtubeData = tokenData.youtubeData;

        if (!youtubeData || !youtubeData.user || !youtubeData.token) {
          throw new Error('Données YouTube manquantes');
        }

        // Configuration par défaut
        const config = {
          target: 1000,
          text: "Objectif : {current}/{target} abonnés",
          progressColor: "#FF0000",
          textColor: "#FFFFFF",
          showBackground: true,
          showProgressBar: true,
          showPercentage: true
        };

        // Charger la configuration sauvegardée
        const savedConfig = localStorage.getItem('subscribers_goal_config');
        if (savedConfig) {
          Object.assign(config, JSON.parse(savedConfig));
        }

        // Mettre à jour les valeurs du formulaire
        function updateFormValues() {
          document.getElementById('goal-target').value = config.target;
          document.getElementById('goal-text').value = config.text;
          document.getElementById('progress-color').value = config.progressColor;
          document.getElementById('text-color').value = config.textColor;
          document.getElementById('show-background').checked = config.showBackground;
          document.getElementById('show-progress-bar').checked = config.showProgressBar;
          document.getElementById('show-percentage').checked = config.showPercentage;
          updatePreview();
          updateObsLink();
        }

        // Mettre à jour l'aperçu
        function updatePreview() {
          const previewFrame = document.getElementById('preview-frame');
          if (!previewFrame) return;

          const params = new URLSearchParams();
          Object.entries(config).forEach(([key, value]) => {
            params.set(key, value);
          });
          params.set('token', token);
          
          previewFrame.src = `overlay.html?${params.toString()}`;
        }

        // Générer et mettre à jour le lien OBS
        function updateObsLink() {
          const params = new URLSearchParams();
          Object.entries(config).forEach(([key, value]) => {
            params.set(key, value);
          });
          params.set('token', token);

          const obsUrl = `${window.location.origin}/src/overlays/youtube/subscribers-goal/overlay.html?${params.toString()}`;
          const obsLinkInput = document.getElementById('obs-link');
          if (obsLinkInput) {
            obsLinkInput.value = obsUrl;
          }
        }

        // Gestionnaire de copie du lien
        document.getElementById('copy-link')?.addEventListener('click', () => {
          const obsLink = document.getElementById('obs-link');
          obsLink.select();
          document.execCommand('copy');
          
          const successMessage = document.createElement('div');
          successMessage.className = 'save-success';
          successMessage.textContent = 'Lien copié !';
          document.body.appendChild(successMessage);
          setTimeout(() => successMessage.remove(), 3000);
        });

        // Gestionnaire de sauvegarde
        document.getElementById('save-config')?.addEventListener('click', () => {
          config.target = parseInt(document.getElementById('goal-target').value);
          config.text = document.getElementById('goal-text').value;
          config.progressColor = document.getElementById('progress-color').value;
          config.textColor = document.getElementById('text-color').value;
          config.showBackground = document.getElementById('show-background').checked;
          config.showProgressBar = document.getElementById('show-progress-bar').checked;
          config.showPercentage = document.getElementById('show-percentage').checked;

          // Sauvegarder localement
          localStorage.setItem('subscribers_goal_config', JSON.stringify(config));

          // Mettre à jour l'aperçu et le lien
          updatePreview();
          updateObsLink();

          // Message de confirmation
          const successMessage = document.createElement('div');
          successMessage.className = 'save-success';
          successMessage.textContent = 'Configuration enregistrée !';
          document.body.appendChild(successMessage);
          setTimeout(() => successMessage.remove(), 3000);

          // Diffuser la mise à jour
          const broadcastChannel = new BroadcastChannel('subscribers_goal_update');
          broadcastChannel.postMessage({
            type: 'config_update',
            userId: youtubeData.user.id,
            config: config
          });
        });

        // Initialiser les valeurs
        updateFormValues();

      } catch (error) {
        console.error('Erreur lors de l\'initialisation:', error);
        alert('Une erreur est survenue lors du chargement de la configuration');
        window.location.href = '/src/youtube-dashboard.html';
      }
    });
  </script>
</body>
</html>